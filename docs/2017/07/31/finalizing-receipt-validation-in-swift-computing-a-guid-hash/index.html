<!DOCTYPE html>
<html lang="en">

<head>

    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-33022655-1"></script>
    <script>
            (function () {
                if (window.location.hostname === "localhost") {
                    console.log("Analytics not running on local dev.");
                    return;
                } else {
                    window.dataLayer = window.dataLayer || [];
                    function gtag() { dataLayer.push(arguments); }
                    gtag('js', new Date());

                    gtag('config', 'UA-33022655-1');
                }
            })();
    </script>

    

    <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.css" />
    <script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.js"></script>
    <script>
    window.addEventListener("load", function(){
    window.cookieconsent.initialise({
    "palette": {
        "popup": {
        "background": "#3e8bc5"
        },
        "button": {
        "background": "#8ec760",
        "text": "#ffffff"
        }
    }
    })});
    </script>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta property="og:title" content="Finalizing Receipt Validation in Swift – Computing a GUID Hash" />
<meta property="og:description" content="The aim of this guide is to help you finalize the receipt validation process by computing the GUID hash for your app, and comparing it to the hash that&#39;s stored within your receipt itself." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.andrewcbancroft.com/2017/07/31/finalizing-receipt-validation-in-swift-computing-a-guid-hash/" />
<meta property="article:published_time" content="2017-07-31T12:36:26&#43;00:00"/>
<meta property="article:modified_time" content="2019-06-26T00:00:00&#43;00:00"/>

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Finalizing Receipt Validation in Swift – Computing a GUID Hash"/>
<meta name="twitter:description" content="The aim of this guide is to help you finalize the receipt validation process by computing the GUID hash for your app, and comparing it to the hash that&#39;s stored within your receipt itself."/>
<meta name="generator" content="Hugo 0.55.6" /> 
    
    
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "headline": "Finalizing Receipt Validation in Swift – Computing a GUID Hash",
  "url": "https:\/\/www.andrewcbancroft.com\/2017\/07\/31\/finalizing-receipt-validation-in-swift-computing-a-guid-hash\/",
  "wordCount": "1513",
  "datePublished": "2017-07-31T12:36:26Z",
  "dateModified": "2019-06-26T00:00:00Z",
  "author": {
    "@type": "Person",
    "name": "Andrew"
  },
  "keywords": "In-App Purchases, Receipt Validation, Swift"

  ,"description": "The aim of this guide is to help you finalize the receipt validation process by computing the GUID hash for your app, and comparing it to the hash that's stored within your receipt itself."
}
</script>



    <title>Finalizing Receipt Validation in Swift – Computing a GUID Hash</title>

    
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb"
        crossorigin="anonymous">

    
    <link href="https://www.andrewcbancroft.com/css/custom.css" rel="stylesheet"> 
    <link href="https://www.andrewcbancroft.com/css/syntax.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Muli:400,500,700" rel="stylesheet">
        
    <link href="" rel="alternate" type="application/rss+xml" title="Andrew Bancroft" /> 
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css" integrity="sha384-oS3vJWv+0UjzBfQzYUhtDYW+Pj2yciDJxpsK1OYPAYjqT085Qq/1cq5FLXAZQ7Ay" crossorigin="anonymous">
    <script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[','\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre','code'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});
</script>

</head>

<body>

    <nav class="navbar navbar-expand-lg fixed-top px-5">
            <a class="navbar-brand" href="https://www.andrewcbancroft.com"><i class="fas fa-home"></i> Andrew Bancroft</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="nav navbar-nav mr-auto mt-2 mt-lg-0"></ul>
                <ul class="navbar-nav">
                        <li class="nav-item">
                                <a class="nav-link" href="https://www.andrewcbancroft.com#pluralsight-courses">Pluralsight Courses</a>
                        </li>

                    <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true"
                                aria-expanded="false">
                                Topics
                            </a>
                            <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">
                                <h6 class="dropdown-header">iOS Development</h6>
                                <a class="dropdown-item" href="https://www.andrewcbancroft.com#data-persistence">Data Persistence</a>
                                <a class="dropdown-item" href="https://www.andrewcbancroft.com#dependency-management">Dependency Management</a>
                                <a class="dropdown-item" href="https://www.andrewcbancroft.com#debugging">Debugging</a>
                                <a class="dropdown-item" href="https://www.andrewcbancroft.com#eventkit">Event Kit</a>
                                <a class="dropdown-item" href="https://www.andrewcbancroft.com#iap">In-App Purchases</a>
                                <a class="dropdown-item" href="https://www.andrewcbancroft.com#parse">Parse</a>
                                <a class="dropdown-item" href="https://www.andrewcbancroft.com#patterns-and-practices">Patterns and Practices</a>
                                <a class="dropdown-item" href="https://www.andrewcbancroft.com#react-native">React Native</a>
                                <a class="dropdown-item" href="https://www.andrewcbancroft.com#swift-how-tos">Swift How-To's</a>
                                <a class="dropdown-item" href="https://www.andrewcbancroft.com#swift-language-notes">Swift Language Notes</a>
                                
                                <a class="dropdown-item" href="https://www.andrewcbancroft.com#testing">Testing</a>
                                <a class="dropdown-item" href="https://www.andrewcbancroft.com#ui-work">User Interface Work</a>
                                <a class="dropdown-item" href="https://www.andrewcbancroft.com#xcode">Xcode</a>
                                <div class="dropdown-divider"></div>
                                <a class="dropdown-item" href="https://www.andrewcbancroft.com#dot-net-development">.Net Development</a>
                                <div class="dropdown-divider"></div>
                                <a class="dropdown-item" href="https://www.andrewcbancroft.com#musings">Musings</a>
                            </div>
                        </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true"
                            aria-expanded="false">
                            Connect With Me
                        </a>
                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">
                            <a class="dropdown-item" href="https://www.pluralsight.com/authors/andrew-bancroft"><i class="fas fa-play"></i> Pluralsight Courses</a>
                            <a class="dropdown-item" href="https://github.com/andrewcbancroft"><i class="fab fa-github"></i> GitHub</a>
                            <a class="dropdown-item" href="https://www.linkedin.com/in/andrewcbancroft/"><i class="fab fa-linkedin"></i> LinkedIn</a>
                            <a class="dropdown-item" href="https://twitter.com/andrewcbancroft"><i class="fab fa-twitter"></i> Twitter</a>
                            <a class="dropdown-item" href="https://www.youtube.com/channel/UCDPV9kMhP-b5EFRI7d812pg"><i class="fab fa-youtube"></i> YouTube</a>
                            <a class="dropdown-item" href="https://dataday.life"><i class="fas fa-link"></i> www.dataday.life</a>
                            <a class="dropdown-item" href="https://www.andrewcbancroft.com/index.xml"><i class="fas fa-rss"></i> Feed</a>
                        </div>
                    </li>
                </ul>
        </div>
    </nav>

    
    
    
    
    
    
    
    

    
    <div class="container">
        <div class="row">
            <div class="col-sm-12">

                


<article>
  <div class="article">
    <header>
        <div class="alert alert-primary" role="alert">
            Learning about in-app purchases on iOS? <br/><br/>
            I am the author of <a href="https://bit.ly/implementing-in-app-purchases-ios" class="alert-link">Implementing In-app Purchases on iOS</a> on <a href="http://bit.ly/ps-author-page" class="alert-link">Pluralsight</a>.  <br/><br/>Deepen your understanding by watching the course!
          </div>
      <h1 class="article-title">Finalizing Receipt Validation in Swift – Computing a GUID Hash</h1>
    </header>
    <div class="content">

    <p></p>

    

<p>The aim of this guide is to help you finalize the receipt validation process by computing the GUID hash for your app, and comparing it to the hash that&rsquo;s stored within your receipt itself.</p>

<p>This is a continuation of my receipt validation series. I&rsquo;m assuming that&#8230;</p>

<ul>
<li>You&rsquo;ve <a href="https://www.andrewcbancroft.com/2015/10/05/preparing-to-test-receipt-validation-for-ios/">prepared to test receipt validation</a> by setting up your app in iTunes Connect.</li>
<li>You&rsquo;ve brought in a cryptography library like OpenSSL to be able to work with the PKCS #7 container that acts as the &ldquo;envelope&#8221; for the receipt. Perhaps you&rsquo;ve even done it <a href="https://www.andrewcbancroft.com/2015/09/21/openssl-for-ios-swift-the-easy-way/">the &ldquo;easy way&#8221; with CocoaPods</a>.</li>
<li>You&rsquo;ve <a href="https://www.andrewcbancroft.com/2015/10/13/loading-a-receipt-for-validation-with-swift/">located and loaded</a> the receipt for validation.</li>
<li>You&rsquo;ve <a href="https://www.andrewcbancroft.com/2016/06/09/extracting-a-pkcs7-container-for-receipt-validation-with-swift/">extracted the PKCS #7 container</a>.</li>
<li>You&rsquo;ve <a href="https://www.andrewcbancroft.com/2017/07/16/receipt-validation-verifying-a-receipt-signature-in-swift/">verified the signature on the receipt</a></li>
<li>You&rsquo;ve <a href="https://www.andrewcbancroft.com/2017/07/27/receipt-validation-parsing-a-receipt-with-swift/">parsed and decoded the receipt payload</a></li>
</ul>

<p>After finishing this guide, you&rsquo;ll simply need to use the parsed receipt data to perform any app-specific enabling/disabling of features based on the data within a valid receipt. If the receipt is <em>invalid</em>, you&rsquo;ll need to handle that as well. But all of the relatively difficult work of working with the Open SSL crypto library will be DONE after this guide.</p>

<p>Just want the code? Here you go!</p>

<div class="resources">
  <div class="resources-header">
    Resources
  </div>
  <ul class="resources-content">
    <li>
      <i class="fab fa-github fa-lg"></i> <a href="https://github.com/andrewcbancroft/SwiftyLocalReceiptValidator">Swifty Local Receipt Validator</a>
    </li>
  </ul>
</div>

<p>Ready? Let&rsquo;s do this thing!</p>

<p><a name="validating-with-receipt-validator" class="jump-target"></a></p>

<h2 id="validating-the-device-guid-hash-with-receiptvalidator">Validating the device GUID hash with ReceiptValidator</h2>

<p>For this final step, I&rsquo;ve imagined a single additional function within the <a href="https://www.andrewcbancroft.com/2015/10/13/loading-a-receipt-for-validation-with-swift/#receipt-validator-implementation"><code>ReceiptValidator</code> struct</a> called <code>validateHash(receipt:)</code>.</p>

<p>It&rsquo;ll take in a <code>ParsedReceipt</code> (<a href="https://www.andrewcbancroft.com/2017/07/27/receipt-validation-parsing-a-receipt-with-swift/#final-goal">review what it looks like</a>), and will to the computation and comparison necessary to verify that the computed hash matches the hash stored in the receipt.</p>

<p>A <code>ReceiptValidationError</code> will be thrown if things go wrong within this function. No <code>ReceiptValidationError</code> being thrown indicates a successful hash computation and comparison.</p>

<p>Here&rsquo;s the skeleton of the function:</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-swift" data-lang="swift"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-swift" data-lang="swift"><span class="n">fileprivate</span> <span class="kd">func</span> <span class="nf">validateHash</span><span class="p">(</span><span class="n">receipt</span><span class="p">:</span> <span class="n">ParsedReceipt</span><span class="p">)</span> <span class="kr">throws</span> <span class="p">{</span>
    <span class="c1">// Make sure that the ParsedReceipt instances has non-nil values needed for hash comparison</span>

    <span class="c1">// Compute the hash for your app &amp; device</span>

    <span class="c1">// Compare the computed hash with the receipt&#39;s hash</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>

<p><a name="signaling-validation-failure" class="jump-target"></a></p>

<h2 id="signaling-hash-validation-failure">Signaling hash validation failure</h2>

<p>Before I get into the implementation of the <code>validateHash(receipt:)</code> function, let&rsquo;s define one more <code>ReceiptValidationError</code> case to describe a bad hash comparison outcome:</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-swift" data-lang="swift"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">enum</span> <span class="nc">ReceiptValidationError</span> <span class="p">:</span> <span class="n">Error</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">couldNotFindReceipt</span>
    <span class="k">case</span> <span class="n">emptyReceiptContents</span>
    <span class="k">case</span> <span class="n">receiptNotSigned</span>
    <span class="k">case</span> <span class="n">appleRootCertificateNotFound</span>
    <span class="k">case</span> <span class="n">receiptSignatureInvalid</span>
    <span class="k">case</span> <span class="n">malformedReceipt</span>
    <span class="k">case</span> <span class="n">malformedInAppPurchaseReceipt</span>
    <span class="k">case</span> <span class="n">incorrectHash</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>

<p><a name="implementing-validate-hash" class="jump-target"></a></p>

<h2 id="implementing-validatehash-function">Implementing validateHash function</h2>

<p>I&rsquo;ll put the code in front of you, and then do my best to explain my thought process.</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-swift" data-lang="swift"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-swift" data-lang="swift"><span class="n">fileprivate</span> <span class="kd">func</span> <span class="nf">validateHash</span><span class="p">(</span><span class="n">receipt</span><span class="p">:</span> <span class="n">ParsedReceipt</span><span class="p">)</span> <span class="kr">throws</span> <span class="p">{</span>
    <span class="c1">// Make sure that the ParsedReceipt instances has non-nil values needed for hash comparison</span>
    <span class="k">guard</span> <span class="kd">let</span> <span class="nv">receiptOpaqueValueData</span> <span class="p">=</span> <span class="n">receipt</span><span class="p">.</span><span class="n">opaqueValue</span> <span class="k">else</span> <span class="p">{</span> <span class="k">throw</span> <span class="n">ReceiptValidationError</span><span class="p">.</span><span class="n">incorrectHash</span> <span class="p">}</span>
    <span class="k">guard</span> <span class="kd">let</span> <span class="nv">receiptBundleIdData</span> <span class="p">=</span> <span class="n">receipt</span><span class="p">.</span><span class="n">bundleIdData</span> <span class="k">else</span> <span class="p">{</span> <span class="k">throw</span> <span class="n">ReceiptValidationError</span><span class="p">.</span><span class="n">incorrectHash</span> <span class="p">}</span>
    <span class="k">guard</span> <span class="kd">let</span> <span class="nv">receiptHashData</span> <span class="p">=</span> <span class="n">receipt</span><span class="p">.</span><span class="n">sha1Hash</span> <span class="k">else</span> <span class="p">{</span> <span class="k">throw</span> <span class="n">ReceiptValidationError</span><span class="p">.</span><span class="n">incorrectHash</span> <span class="p">}</span>
    
    <span class="kd">var</span> <span class="nv">deviceIdentifier</span> <span class="p">=</span> <span class="n">UIDevice</span><span class="p">.</span><span class="n">current</span><span class="p">.</span><span class="n">identifierForVendor</span><span class="p">?.</span><span class="n">uuid</span>
    
    <span class="kd">let</span> <span class="nv">rawDeviceIdentifierPointer</span> <span class="p">=</span> <span class="bp">withUnsafePointer</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">deviceIdentifier</span><span class="p">,</span> <span class="p">{</span>
        <span class="p">(</span><span class="n">unsafeDeviceIdentifierPointer</span><span class="p">:</span> <span class="nb">UnsafePointer</span><span class="p">&lt;</span><span class="n">uuid_t</span><span class="p">?</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">UnsafeRawPointer</span> <span class="k">in</span>
        <span class="k">return</span> <span class="n">UnsafeRawPointer</span><span class="p">(</span><span class="n">unsafeDeviceIdentifierPointer</span><span class="p">)</span>
    <span class="p">})</span>
    
    <span class="kd">let</span> <span class="nv">deviceIdentifierData</span> <span class="p">=</span> <span class="n">NSData</span><span class="p">(</span><span class="n">bytes</span><span class="p">:</span> <span class="n">rawDeviceIdentifierPointer</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="mi">16</span><span class="p">)</span>
    
    <span class="c1">// Compute the hash for your app &amp; device</span>
    
    <span class="c1">// Set up the hasing context</span>
    <span class="kd">var</span> <span class="nv">computedHash</span> <span class="p">=</span> <span class="nb">Array</span><span class="p">&lt;</span><span class="nb">UInt8</span><span class="o">&gt;</span><span class="p">(</span><span class="n">repeating</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">count</span><span class="p">:</span> <span class="mi">20</span><span class="p">)</span>
    <span class="kd">var</span> <span class="nv">sha1Context</span> <span class="p">=</span> <span class="n">SHA_CTX</span><span class="p">()</span>
    
    <span class="n">SHA1_Init</span><span class="p">(&amp;</span><span class="n">sha1Context</span><span class="p">)</span>
    <span class="n">SHA1_Update</span><span class="p">(&amp;</span><span class="n">sha1Context</span><span class="p">,</span> <span class="n">deviceIdentifierData</span><span class="p">.</span><span class="n">bytes</span><span class="p">,</span> <span class="n">deviceIdentifierData</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
    <span class="n">SHA1_Update</span><span class="p">(&amp;</span><span class="n">sha1Context</span><span class="p">,</span> <span class="n">receiptOpaqueValueData</span><span class="p">.</span><span class="n">bytes</span><span class="p">,</span> <span class="n">receiptOpaqueValueData</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
    <span class="n">SHA1_Update</span><span class="p">(&amp;</span><span class="n">sha1Context</span><span class="p">,</span> <span class="n">receiptBundleIdData</span><span class="p">.</span><span class="n">bytes</span><span class="p">,</span> <span class="n">receiptBundleIdData</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
    <span class="n">SHA1_Final</span><span class="p">(&amp;</span><span class="n">computedHash</span><span class="p">,</span> <span class="p">&amp;</span><span class="n">sha1Context</span><span class="p">)</span>
    
    <span class="kd">let</span> <span class="nv">computedHashData</span> <span class="p">=</span> <span class="n">NSData</span><span class="p">(</span><span class="n">bytes</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">computedHash</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="mi">20</span><span class="p">)</span>
    
    <span class="c1">// Compare the computed hash with the receipt&#39;s hash</span>
    <span class="k">guard</span> <span class="n">computedHashData</span><span class="p">.</span><span class="n">isEqual</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="n">receiptHashData</span> <span class="k">as</span> <span class="n">Data</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span> <span class="k">throw</span> <span class="n">ReceiptValidationError</span><span class="p">.</span><span class="n">incorrectHash</span> <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>

<p><a name="walkthrough" class="jump-target"></a></p>

<h4 id="walking-through-validatehash">Walking through validateHash</h4>

<p>First up, I&rsquo;ve placed three guard statements:</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-swift" data-lang="swift"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-swift" data-lang="swift"><span class="k">guard</span> <span class="kd">let</span> <span class="nv">receiptOpaqueValueData</span> <span class="p">=</span> <span class="n">receipt</span><span class="p">.</span><span class="n">opaqueValue</span> <span class="k">else</span> <span class="p">{</span> <span class="k">throw</span> <span class="n">ReceiptValidationError</span><span class="p">.</span><span class="n">incorrectHash</span> <span class="p">}</span>
<span class="k">guard</span> <span class="kd">let</span> <span class="nv">receiptBundleIdData</span> <span class="p">=</span> <span class="n">receipt</span><span class="p">.</span><span class="n">bundleIdData</span> <span class="k">else</span> <span class="p">{</span> <span class="k">throw</span> <span class="n">ReceiptValidationError</span><span class="p">.</span><span class="n">incorrectHash</span> <span class="p">}</span>
<span class="k">guard</span> <span class="kd">let</span> <span class="nv">receiptHashData</span> <span class="p">=</span> <span class="n">receipt</span><span class="p">.</span><span class="n">sha1Hash</span> <span class="k">else</span> <span class="p">{</span> <span class="k">throw</span> <span class="n">ReceiptValidationError</span><span class="p">.</span><span class="n">incorrectHash</span> <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>

<p>These help guarantee that the rest of the function will have all of the required pieces of data that it needs to fully compute a hash and compare it with what&rsquo;s in the receipt.</p>

<p>The hash for your app is computed with the following three pieces of information:<br />
1) The app purchaser&rsquo;s device identifier<br />
2) A piece of &ldquo;opaque data&#8221; found within the receipt<br />
3) Your app&rsquo;s bundle identifier found within the receipt</p>

<p>The app purchaser&rsquo;s device identifier is represented as a <code>uuid_t</code> from the Foundation library. However, to use it with the Open SSL library, we&rsquo;ll need to be working with an <code>NSData</code> instance. The following code goes from the <code>uuid_t</code> instance, to a raw pointer, to an <code>NSData</code> instance:</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-swift" data-lang="swift"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">var</span> <span class="nv">deviceIdentifier</span> <span class="p">=</span> <span class="n">UIDevice</span><span class="p">.</span><span class="n">current</span><span class="p">.</span><span class="n">identifierForVendor</span><span class="p">?.</span><span class="n">uuid</span>

<span class="kd">let</span> <span class="nv">rawDeviceIdentifierPointer</span> <span class="p">=</span> <span class="bp">withUnsafePointer</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">deviceIdentifier</span><span class="p">,</span> <span class="p">{</span>
    <span class="p">(</span><span class="n">unsafeDeviceIdentifierPointer</span><span class="p">:</span> <span class="nb">UnsafePointer</span><span class="p">&lt;</span><span class="n">uuid_t</span><span class="p">?</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">UnsafeRawPointer</span> <span class="k">in</span>
    <span class="k">return</span> <span class="n">UnsafeRawPointer</span><span class="p">(</span><span class="n">unsafeDeviceIdentifierPointer</span><span class="p">)</span>
<span class="p">})</span>

<span class="kd">let</span> <span class="nv">deviceIdentifierData</span> <span class="p">=</span> <span class="n">NSData</span><span class="p">(</span><span class="n">bytes</span><span class="p">:</span> <span class="n">rawDeviceIdentifierPointer</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="mi">16</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>

<p>The last chunk of code within the function actually computes the hash data.</p>

<p>The hash is a SHA1 hash, so what we do here is initialize a SHA1 context, and then update it with all of the ingredients (device identifier, opaque data, and bundle identifier). The hash is finalized, and converted to an instance of <code>NSData</code>.</p>

<p>The final guard takes the <code>computedHashData</code> instance, and compares it to the receipt&rsquo;s hash data. If it&rsquo;s identical, validation passes! Otherwise, <code>ReceiptValidationError.incorrectHash</code> is thrown.</p>

<p><a name="final-receipt-validator" class="jump-target"></a></p>

<h2 id="final-receiptvalidator">Final ReceiptValidator</h2>

<p>Let&rsquo;s put it all together into the final <code>ReceiptValidator</code> struct. Additions are highlighted below:</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-swift" data-lang="swift"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">struct</span> <span class="nc">ReceiptValidator</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">receiptLoader</span> <span class="p">=</span> <span class="n">ReceiptLoader</span><span class="p">()</span>
    <span class="kd">let</span> <span class="nv">receiptExtractor</span> <span class="p">=</span> <span class="n">ReceiptExtractor</span><span class="p">()</span>
    <span class="kd">let</span> <span class="nv">receiptSignatureValidator</span> <span class="p">=</span> <span class="n">ReceiptSignatureValidator</span><span class="p">()</span>
    <span class="kd">let</span> <span class="nv">receiptParser</span> <span class="p">=</span> <span class="n">ReceiptParser</span><span class="p">()</span>
    
    <span class="kd">func</span> <span class="nf">validateReceipt</span><span class="p">()</span> <span class="p">-&gt;</span> <span class="n">ReceiptValidationResult</span> <span class="p">{</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="kd">let</span> <span class="nv">receiptData</span> <span class="p">=</span> <span class="k">try</span> <span class="n">receiptLoader</span><span class="p">.</span><span class="n">loadReceipt</span><span class="p">()</span>
            <span class="kd">let</span> <span class="nv">receiptContainer</span> <span class="p">=</span> <span class="k">try</span> <span class="n">receiptExtractor</span><span class="p">.</span><span class="n">extractPKCS7Container</span><span class="p">(</span><span class="n">receiptData</span><span class="p">)</span>
            
            <span class="k">try</span> <span class="n">receiptSignatureValidator</span><span class="p">.</span><span class="n">checkSignaturePresence</span><span class="p">(</span><span class="n">receiptContainer</span><span class="p">)</span>
            <span class="k">try</span> <span class="n">receiptSignatureValidator</span><span class="p">.</span><span class="n">checkSignatureAuthenticity</span><span class="p">(</span><span class="n">receiptContainer</span><span class="p">)</span>
            
            <span class="kd">let</span> <span class="nv">parsedReceipt</span> <span class="p">=</span> <span class="k">try</span> <span class="n">receiptParser</span><span class="p">.</span><span class="n">parse</span><span class="p">(</span><span class="n">receiptContainer</span><span class="p">)</span>
            <span class="k">try</span> <span class="n">validateHash</span><span class="p">(</span><span class="n">receipt</span><span class="p">:</span> <span class="n">parsedReceipt</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="n">parsedReceipt</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
            <span class="k">return</span> <span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span> <span class="k">as</span><span class="o">!</span> <span class="n">ReceiptValidationError</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="n">fileprivate</span> <span class="kd">func</span> <span class="nf">validateHash</span><span class="p">(</span><span class="n">receipt</span><span class="p">:</span> <span class="n">ParsedReceipt</span><span class="p">)</span> <span class="kr">throws</span> <span class="p">{</span>
        <span class="c1">// Make sure that the ParsedReceipt instances has non-nil values needed for hash comparison</span>
        <span class="k">guard</span> <span class="kd">let</span> <span class="nv">receiptOpaqueValueData</span> <span class="p">=</span> <span class="n">receipt</span><span class="p">.</span><span class="n">opaqueValue</span> <span class="k">else</span> <span class="p">{</span> <span class="k">throw</span> <span class="n">ReceiptValidationError</span><span class="p">.</span><span class="n">incorrectHash</span> <span class="p">}</span>
        <span class="k">guard</span> <span class="kd">let</span> <span class="nv">receiptBundleIdData</span> <span class="p">=</span> <span class="n">receipt</span><span class="p">.</span><span class="n">bundleIdData</span> <span class="k">else</span> <span class="p">{</span> <span class="k">throw</span> <span class="n">ReceiptValidationError</span><span class="p">.</span><span class="n">incorrectHash</span> <span class="p">}</span>
        <span class="k">guard</span> <span class="kd">let</span> <span class="nv">receiptHashData</span> <span class="p">=</span> <span class="n">receipt</span><span class="p">.</span><span class="n">sha1Hash</span> <span class="k">else</span> <span class="p">{</span> <span class="k">throw</span> <span class="n">ReceiptValidationError</span><span class="p">.</span><span class="n">incorrectHash</span> <span class="p">}</span>
        
        <span class="kd">var</span> <span class="nv">deviceIdentifier</span> <span class="p">=</span> <span class="n">UIDevice</span><span class="p">.</span><span class="n">current</span><span class="p">.</span><span class="n">identifierForVendor</span><span class="p">?.</span><span class="n">uuid</span>
        
        <span class="kd">let</span> <span class="nv">rawDeviceIdentifierPointer</span> <span class="p">=</span> <span class="bp">withUnsafePointer</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">deviceIdentifier</span><span class="p">,</span> <span class="p">{</span>
            <span class="p">(</span><span class="n">unsafeDeviceIdentifierPointer</span><span class="p">:</span> <span class="nb">UnsafePointer</span><span class="p">&lt;</span><span class="n">uuid_t</span><span class="p">?</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">UnsafeRawPointer</span> <span class="k">in</span>
            <span class="k">return</span> <span class="n">UnsafeRawPointer</span><span class="p">(</span><span class="n">unsafeDeviceIdentifierPointer</span><span class="p">)</span>
        <span class="p">})</span>
        
        <span class="kd">let</span> <span class="nv">deviceIdentifierData</span> <span class="p">=</span> <span class="n">NSData</span><span class="p">(</span><span class="n">bytes</span><span class="p">:</span> <span class="n">rawDeviceIdentifierPointer</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="mi">16</span><span class="p">)</span>
        
        <span class="c1">// Compute the hash for your app &amp; device</span>
        
        <span class="c1">// Set up the hasing context</span>
        <span class="kd">var</span> <span class="nv">computedHash</span> <span class="p">=</span> <span class="nb">Array</span><span class="p">&lt;</span><span class="nb">UInt8</span><span class="o">&gt;</span><span class="p">(</span><span class="n">repeating</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">count</span><span class="p">:</span> <span class="mi">20</span><span class="p">)</span>
        <span class="kd">var</span> <span class="nv">sha1Context</span> <span class="p">=</span> <span class="n">SHA_CTX</span><span class="p">()</span>
        
        <span class="n">SHA1_Init</span><span class="p">(&amp;</span><span class="n">sha1Context</span><span class="p">)</span>
        <span class="n">SHA1_Update</span><span class="p">(&amp;</span><span class="n">sha1Context</span><span class="p">,</span> <span class="n">deviceIdentifierData</span><span class="p">.</span><span class="n">bytes</span><span class="p">,</span> <span class="n">deviceIdentifierData</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
        <span class="n">SHA1_Update</span><span class="p">(&amp;</span><span class="n">sha1Context</span><span class="p">,</span> <span class="n">receiptOpaqueValueData</span><span class="p">.</span><span class="n">bytes</span><span class="p">,</span> <span class="n">receiptOpaqueValueData</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
        <span class="n">SHA1_Update</span><span class="p">(&amp;</span><span class="n">sha1Context</span><span class="p">,</span> <span class="n">receiptBundleIdData</span><span class="p">.</span><span class="n">bytes</span><span class="p">,</span> <span class="n">receiptBundleIdData</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
        <span class="n">SHA1_Final</span><span class="p">(&amp;</span><span class="n">computedHash</span><span class="p">,</span> <span class="p">&amp;</span><span class="n">sha1Context</span><span class="p">)</span>
        
        <span class="kd">let</span> <span class="nv">computedHashData</span> <span class="p">=</span> <span class="n">NSData</span><span class="p">(</span><span class="n">bytes</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">computedHash</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="mi">20</span><span class="p">)</span>
        
        <span class="c1">// Compare the computed hash with the receipt&#39;s hash</span>
        <span class="k">guard</span> <span class="n">computedHashData</span><span class="p">.</span><span class="n">isEqual</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="n">receiptHashData</span> <span class="k">as</span> <span class="n">Data</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span> <span class="k">throw</span> <span class="n">ReceiptValidationError</span><span class="p">.</span><span class="n">incorrectHash</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>

<p><a name="what-to-do-from-here" class="jump-target"></a></p>

<h2 id="what-to-do-from-here">What to do from here</h2>

<p>So what now?</p>

<p>Well, at this stage, if no errors have been thrown, you&rsquo;ve got a valid receipt.</p>

<p>The <code>validateReceipt</code> function returns an instance of <code>ParsedReceipt</code> so that you can inspect individual Swift-Typed values from the receipt payload to determine what features you should enable or disable, depending on what your needs are.</p>

<p>If a <code>ReceiptValidationError</code> is thrown at any point along the way, you&rsquo;ll need to handle them.<br />
Here are a few ideas:</p>

<ul>
<li>Implement a grace period, just in case the receipt validation failure occurred for a reason that the user can&rsquo;t control (e.g. maybe we couldn&rsquo;t locate the receipt, and requesting a new one failed because Apple was having issues&#8230;)</li>
<li>Disable a feature in your app because receipt validation failed too many times</li>
<li>Maybe you just need to use the data within the <code>ParsedReceipt</code> because you&rsquo;re changing the way you monetize your app. Now, instead of making users pay $0.99 for the app, you&rsquo;re going to give it away for free, but let people buy an in-app purchase to enable &ldquo;pro&#8221; features, or remove ads&#8230;whatever. In this case, you may check the <code>ParsedReceipt</code> to see the original version of the app that your user downloaded. Maybe you want to require users who download your app after version 2.0 to buy an in-app purchase for <em>Feature X</em>, but you want to give it to everyone who already <em>has</em> the app since they may have already paid $0.99 for it, and it&rsquo;d make them feel ripped off if they had to buy the in-app purchase.</li>
</ul>

<p>How you handle the parsed receipt data or a receipt validation error is really customizable and specific to your particular app.</p>

<p>The bottom line is that from this point on, you no longer need Open SSL or any additional cryptic, low-level, unsafe pointer-type stuff to finish things out.</p>

<p>I hope this series has been helpful in setting you up to validate receipts locally on a user&rsquo;s device!</p>

<p><a name="related" class="jump-target"></a></p>

<div class="resources">
  <div class="resources-header">
    You might also enjoy&#8230;
  </div>
  <ul class="resources-content">
    <li>
      <i class="fa fa-angle-right"></i> <a href="https://www.andrewcbancroft.com/2015/10/05/preparing-to-test-receipt-validation-for-ios/" title="Preparing to Test Receipt Validation for iOS">Preparing to Test Receipt Validation for iOS</a>
    </li>
    <li>
      <i class="fa fa-angle-right"></i> <a href="https://www.andrewcbancroft.com/2015/10/13/loading-a-receipt-for-validation-with-swift/" title="Loading a Receipt for Validation with Swift">Loading a Receipt for Validation with Swift</a>
    </li>
    <li>
      <i class="fa fa-angle-right"></i> <a href="https://www.andrewcbancroft.com/2015/09/21/openssl-for-ios-swift-the-easy-way/" title="OpenSSL for iOS &#038; Swift the Easy Way">OpenSSL for iOS & Swift the Easy Way</a>
    </li>
    <li>
      <i class="fa fa-angle-right"></i> <a href="https://www.andrewcbancroft.com/2016/06/09/extracting-a-pkcs7-container-for-receipt-validation-with-swift/" Extracting a PKCS7 Container for Receipt Validation with Swift="title">Extracting a PKCS7 Container for Receipt Validation with Swift</a>
    </li>
    <li>
      <i class="fa fa-angle-right"></i> <a href="https://www.andrewcbancroft.com/2017/07/16/receipt-validation-verifying-a-receipt-signature-in-swift/" Receipt Validation – Verifying a Receipt Signature in Swift="title">Receipt Validation – Verifying a Receipt Signature in Swift</a>
    </li>
    <li>
      <i class="fa fa-angle-right"></i> <a href="https://www.andrewcbancroft.com/2017/07/27/receipt-validation-parsing-a-receipt-with-swift/" Receipt Validation – Parse and Decode a Receipt with Swift="title">Receipt Validation – Parse and Decode a Receipt with Swift</a>
    </li>
  </ul>
</div>

<p><a name="share" class="jump-target"></a></p>


    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "andrewcbancroft" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </article>



            </div>

        </div>
    </div>

    

    <footer class="footer text-center">
        <div class="container">
            <span class="text-muted">This project contains 180 pages and is available on <a href="https://github.com/andrewcbancroft/andrewcbancroft-blog/tree/master/content/blog">GitHub</a>. Copyright &copy; Andrew Bancroft, <time datetime="2020">2020</time>.</span>
        </div>
    </footer>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ"
        crossorigin="anonymous"></script>

</body>

</html>