<!DOCTYPE html>
<html lang="en">

<head>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-89T75EE32J"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-89T75EE32J');
    </script>
    

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356224024630676"
crossorigin="anonymous"></script>
<script>
(adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-6356224024630676",
    enable_page_level_ads: true,
    overlays: { bottom: true }
});
</script>


    <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.css" />
    <script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.js"></script>
    <script>
        window.addEventListener("load", function () {
            window.cookieconsent.initialise({
                "palette": {
                    "popup": {
                        "background": "#3e8bc5"
                    },
                    "button": {
                        "background": "#8ec760",
                        "text": "#ffffff"
                    }
                }
            })
        });
    </script>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta property="og:title" content="Receipt Validation –  Parse and Decode a Receipt with Swift" />
<meta property="og:description" content="The aim of this guide is to help you parse a receipt and decode it so that you have readable pieces of metadata to inspect and finalize all of the receipt validation steps." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.andrewcbancroft.com/2017/07/27/receipt-validation-parsing-a-receipt-with-swift/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2017-07-28T03:41:33+00:00" />
<meta property="article:modified_time" content="2019-06-27T00:00:00+00:00" />


<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Receipt Validation –  Parse and Decode a Receipt with Swift"/>
<meta name="twitter:description" content="The aim of this guide is to help you parse a receipt and decode it so that you have readable pieces of metadata to inspect and finalize all of the receipt validation steps."/>
<meta name="generator" content="Hugo 0.121.1">

    
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "headline": "Receipt Validation –  Parse and Decode a Receipt with Swift",
  "url": "https:\/\/www.andrewcbancroft.com\/2017\/07\/27\/receipt-validation-parsing-a-receipt-with-swift\/",
  "wordCount": "3666",
  "datePublished": "2017-07-28T03:41:33Z",
  "dateModified": "2019-06-27T00:00:00Z",
  "author": {
    "@type": "Person",
    "name": "Andrew"
  },
  "keywords": "In-App Purchases, Receipt Validation, Swift"

  ,"description": "The aim of this guide is to help you parse a receipt and decode it so that you have readable pieces of metadata to inspect and finalize all of the receipt validation steps."
}
</script>



    <title>Receipt Validation –  Parse and Decode a Receipt with Swift</title>

    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    
    

    
    <link href="https://www.andrewcbancroft.com/css/custom.css" rel="stylesheet">
    <link href="https://www.andrewcbancroft.com/css/syntax.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Muli:400,500,700" rel="stylesheet">

    
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css"
        integrity="sha384-oS3vJWv+0UjzBfQzYUhtDYW+Pj2yciDJxpsK1OYPAYjqT085Qq/1cq5FLXAZQ7Ay" crossorigin="anonymous">
    <script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[','\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre','code'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});
</script>

</head>

<body>
    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="https://www.andrewcbancroft.com"><i class="fas fa-home"></i> Andrew Bancroft</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
                aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="nav navbar-nav ms-auto mt-2 mt-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" href="https://www.andrewcbancroft.com#pluralsight-courses">Pluralsight Courses</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button"
                            data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Topics
                        </a>
                        <div class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                            <h6 class="dropdown-header">iOS Development</h6>
                            <a class="dropdown-item" href="https://www.andrewcbancroft.com#data-persistence">Data Persistence</a>
                            <a class="dropdown-item" href="https://www.andrewcbancroft.com#dependency-management">Dependency
                                Management</a>
                            <a class="dropdown-item" href="https://www.andrewcbancroft.com#debugging">Debugging</a>
                            <a class="dropdown-item" href="https://www.andrewcbancroft.com#eventkit">Event Kit</a>
                            <a class="dropdown-item" href="https://www.andrewcbancroft.com#iap">In-App Purchases</a>
                            <a class="dropdown-item" href="https://www.andrewcbancroft.com#parse">Parse</a>
                            <a class="dropdown-item" href="https://www.andrewcbancroft.com#patterns-and-practices">Patterns and
                                Practices</a>
                            <a class="dropdown-item" href="https://www.andrewcbancroft.com#react-native">React Native</a>
                            <a class="dropdown-item" href="https://www.andrewcbancroft.com#swift-five">"Swift Five" Series</a>
                            <a class="dropdown-item" href="https://www.andrewcbancroft.com#swift-how-tos">Swift How-To's</a>
                            <a class="dropdown-item" href="https://www.andrewcbancroft.com#swift-language-notes">Swift Language
                                Notes</a>
                            
                            <a class="dropdown-item" href="https://www.andrewcbancroft.com#testing">Testing</a>
                            <a class="dropdown-item" href="https://www.andrewcbancroft.com#ui-work">User Interface Work</a>
                            <a class="dropdown-item" href="https://www.andrewcbancroft.com#xcode">Xcode</a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="https://www.andrewcbancroft.com#dot-net-development">.Net Development</a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="https://www.andrewcbancroft.com#musings">Musings</a>
                        </div>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button"
                            data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Connect With Me
                        </a>
                        <div class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                            <a class="dropdown-item" href="https://www.andrewcbancroft.com/portfolio"><i
                                class="fas fa-briefcase"></i> Portfolio</a>
                            <a class="dropdown-item" href="https://www.pluralsight.com/authors/andrew-bancroft"><i
                                    class="fas fa-play"></i> Pluralsight Courses</a>
                            <a class="dropdown-item" href="https://github.com/andrewcbancroft"><i class="fab fa-github"></i>
                                GitHub</a>
                            <a class="dropdown-item" href="https://www.linkedin.com/in/andrewcbancroft/"><i
                                    class="fab fa-linkedin"></i> LinkedIn</a>
                            <a class="dropdown-item" rel="me" href="https://hachyderm.io/@andrewcbancroft"><i
                                    class="fab fa-mastodon"></i> Mastodon</a>
                            <a class="dropdown-item" href="https://twitter.com/andrewcbancroft"><i
                                    class="fab fa-twitter"></i> Twitter</a>
                            <a class="dropdown-item" href="https://www.youtube.com/channel/UCDPV9kMhP-b5EFRI7d812pg"><i
                                    class="fab fa-youtube"></i> YouTube</a>
                            <a class="dropdown-item" href="https://dataday.life"><i class="fas fa-link"></i>
                                www.dataday.life</a>
                            <a class="dropdown-item" href="https://www.andrewcbancroft.com/index.xml"><i class="fas fa-rss"></i> Feed</a>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    

    
    
    
    

    
    
    

    
    
<div class="container">
  <div class="row">
      <div class="col-sm-12">


<article>
  <div class="article">
    <header>
        <div class="alert alert-primary" role="alert">
            Learning about in-app purchases on iOS? <br/><br/>
            I am the author of <a href="https://bit.ly/implementing-in-app-purchases-ios" class="alert-link">Implementing In-app Purchases on iOS</a> and <a href="http://bit.ly/ps-author-page" class="alert-link">eight other courses on Pluralsight</a>.  <br/><br/>Deepen your understanding by watching the course!
          </div>
      <h1 class="article-title">Receipt Validation –  Parse and Decode a Receipt with Swift</h1>
    </header>
    <div class="content">

    <p></p>
    <aside class="toc">
      <div class="toc-header">Jump to...</div>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#the-final-goal-a-parsed-receipt">The final goal: A parsed receipt</a></li>
    <li><a href="#visualizing-the-encoded-receipts-structure">Visualizing the encoded receipt&rsquo;s structure</a></li>
    <li><a href="#receipt-parsing-strategy">Receipt parsing strategy</a>
      <ul>
        <li></li>
      </ul>
    </li>
    <li><a href="#preparation-step-helper-decoding-functions">Preparation step: Helper decoding functions</a></li>
    <li><a href="#handling-error-conditions">Handling error conditions</a></li>
    <li><a href="#implenting-receiptparser">Implenting ReceiptParser</a>
      <ul>
        <li></li>
      </ul>
    </li>
    <li><a href="#final-receiptparser">Final <code>ReceiptParser</code></a></li>
    <li><a href="#using-receiptparser">Using <code>ReceiptParser</code></a></li>
    <li><a href="#preparing-to-finish-receipt-validation">Preparing to finish receipt validation!</a></li>
  </ul>
</nav>
    </aside>

    <p>The aim of this guide is to help you parse a receipt and decode it so that you have readable pieces of metadata to inspect and finalize all of the receipt validation steps.</p>
<p>This is a continuation of my receipt validation series. I&rsquo;m assuming that…</p>
<ul>
<li>You&rsquo;ve <a href="https://www.andrewcbancroft.com/2015/10/05/preparing-to-test-receipt-validation-for-ios/">prepared to test receipt validation</a> by setting up your app in iTunes Connect.</li>
<li>You&rsquo;ve brought in a cryptography library like OpenSSL to be able to work with the PKCS #7 container that acts as the &ldquo;envelope&rdquo; for the receipt. Perhaps you&rsquo;ve even done it <a href="https://www.andrewcbancroft.com/2015/09/21/openssl-for-ios-swift-the-easy-way/">the &ldquo;easy way&rdquo; with CocoaPods</a>.</li>
<li>You&rsquo;ve <a href="https://www.andrewcbancroft.com/2015/10/13/loading-a-receipt-for-validation-with-swift/">located and loaded</a> the receipt for validation.</li>
<li>You&rsquo;ve <a href="https://www.andrewcbancroft.com/2016/06/09/extracting-a-pkcs7-container-for-receipt-validation-with-swift/">extracted the PKCS #7 container</a>.</li>
<li>You&rsquo;ve <a href="https://www.andrewcbancroft.com/2017/07/16/receipt-validation-verifying-a-receipt-signature-in-swift/">verified the signature on the receipt</a></li>
</ul>
<p>After finishing this guide, you&rsquo;ll still have to <a href="https://www.andrewcbancroft.com/2017/07/31/finalizing-receipt-validation-in-swift-computing-a-guid-hash/">compute the GUID hash of your app</a> to compare with the hash that&rsquo;s found within the receipt. You&rsquo;ll also have to inspect the receipt data to perform any app-specific verification steps. But in order to do either, you&rsquo;ll need the parsed receipt metadata.</p>
<p>Just want the code? Here you go!</p>
<div class="resources">
  <div class="resources-header">
    Resources
  </div>
  <ul class="resources-content">
    <li>
      <i class="fab fa-github fa-lg"></i> <a href="https://github.com/andrewcbancroft/SwiftyLocalReceiptValidator">Swifty Local Receipt Validator</a>
    </li>
  </ul>
</div>
<p>Want to understand the final <code>ReceiptParser</code>? Let&rsquo;s get to it!</p>
<p><a name="final-goal" class="jump-target"></a></p>
<h2 id="the-final-goal-a-parsed-receipt">The final goal: A parsed receipt</h2>
<p>The final goal of this guide is a parsed receipt.</p>
<p>What do you say we start things off by defining what one looks like?</p>
<p>At the end of the day, what we&rsquo;d like back from the parsing process is a simple struct that contains the various pieces of metadata that are found within the <a href="https://www.andrewcbancroft.com/2016/06/09/extracting-a-pkcs7-container-for-receipt-validation-with-swift/">extracted the PKCS #7 container</a>. Things like…</p>
<ul>
<li>the app&rsquo;s bundle identifier,</li>
<li>the original app version that was purchased,</li>
<li>a collection of all the in app purchase receipts,</li>
<li>etc.</li>
</ul>
<p>How does the following look?</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="kd">struct</span> <span class="nc">ParsedReceipt</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nv">bundleIdentifier</span><span class="p">:</span> <span class="nb">String</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nv">bundleIdData</span><span class="p">:</span> <span class="n">NSData</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nv">appVersion</span><span class="p">:</span> <span class="nb">String</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nv">opaqueValue</span><span class="p">:</span> <span class="n">NSData</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nv">sha1Hash</span><span class="p">:</span> <span class="n">NSData</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nv">inAppPurchaseReceipts</span><span class="p">:</span> <span class="p">[</span><span class="n">ParsedInAppPurchaseReceipt</span><span class="p">]?</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nv">originalAppVersion</span><span class="p">:</span> <span class="nb">String</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nv">receiptCreationDate</span><span class="p">:</span> <span class="n">Date</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nv">expirationDate</span><span class="p">:</span> <span class="n">Date</span><span class="p">?</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">struct</span> <span class="nc">ParsedInAppPurchaseReceipt</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nv">quantity</span><span class="p">:</span> <span class="nb">Int</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nv">productIdentifier</span><span class="p">:</span> <span class="nb">String</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nv">transactionIdentifier</span><span class="p">:</span> <span class="nb">String</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nv">originalTransactionIdentifier</span><span class="p">:</span> <span class="nb">String</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nv">purchaseDate</span><span class="p">:</span> <span class="n">Date</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nv">originalPurchaseDate</span><span class="p">:</span> <span class="n">Date</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nv">subscriptionExpirationDate</span><span class="p">:</span> <span class="n">Date</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nv">cancellationDate</span><span class="p">:</span> <span class="n">Date</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nv">webOrderLineItemId</span><span class="p">:</span> <span class="nb">Int</span><span class="p">?</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
<p>You may be wondering, &ldquo;How&rsquo;d he know what values are encoded within the extracted receipt payload?&rdquo;. Apple has a very handy <a href="https://developer.apple.com/library/content/releasenotes/General/ValidateAppStoreReceipt/Chapters/ReceiptFields.html">list of all the values that are encoded</a>, so I listed each property out in my struct according to their documentation.</p>
<p>Parsing the receipt produces the most valuable piece of the whole process. Sure, it&rsquo;s necessary to go through all of the other validation steps, but having a <strong>decoded receipt</strong> with actual <strong>human-readable values</strong> is, to me, a huge step.</p>
<p>Full disclaimer though: parsing the receipt is not very… Swifty.</p>
<p>We&rsquo;re going to be working with all kinds of ugly things like <code>UnsafeMutablePointers</code>, and cryptically-named C Types.</p>
<p>Let&rsquo;s take it one step at a time though…</p>
<p><a name="visualizing-receipt-structure" class="jump-target"></a></p>
<h2 id="visualizing-the-encoded-receipts-structure">Visualizing the encoded receipt&rsquo;s structure</h2>
<p>Up to now, we&rsquo;ve been working only with the PKCS #7 <em>container</em> for the receipt. Now it&rsquo;s time to dig into the container and see what it actually <em>contains</em>.</p>
<p>If you crack open the container, what you find is a long series of bytes that encode the actual structure of the receipt.</p>
<p>From beginning to end, the bytes <em>should</em> encode what&rsquo;s called an &ldquo;ASN.1 Set&rdquo;. In fact, if you open the PKCS #7 container and it <em>doesn&rsquo;t</em> encode an ASN.1 Set, that&rsquo;d warrant a receipt validation failure…<a href="#handling-error-conditions">more about handling that in a minute</a>.</p>
<p>Here&rsquo;s a visual representation of an ASN.1 Set:<br>
<a href="https://www.andrewcbancroft.com/wp-content/uploads/2017/07/ASN1Set.jpeg"><img src="https://www.andrewcbancroft.com/wp-content/uploads/2017/07/ASN1Set.jpeg" alt="ASN.1 Set" width="923" height="338" class="alignnone size-full wp-image-13513" srcset="https://www.andrewcbancroft.com/wp-content/uploads/2017/07/ASN1Set.jpeg 923w, https://www.andrewcbancroft.com/wp-content/uploads/2017/07/ASN1Set-300x110.jpeg 300w, https://www.andrewcbancroft.com/wp-content/uploads/2017/07/ASN1Set-768x281.jpeg 768w" sizes="(max-width: 923px) 100vw, 923px" /></a></p>
<p>Since we&rsquo;ve just got a bunch of bytes encoding things, there&rsquo;s got to be some way to say, &ldquo;This byte, or these series of bytes, represent [this human understandable thing]&rdquo;.</p>
<p>That&rsquo;s exactly what we&rsquo;ve got, as you can see by the visual representation.</p>
<p>The first byte in the receipt payload (the green box in the visualization) signals that the bytes that follow encode an ASN.1 Set.</p>
<p>The next bytes in the series (the blue box) encode how long the ASN.1 Set is, so that as you&rsquo;re going along parsing and decoding the contents of the Set, you know when to stop.</p>
<p>The final series of bytes (the yellow boxes) encode chunks of information that can be decoded to give you human readable receipt attributes. Those chunks, themselves, are encoded as ASN.1 <em>Sequences</em>.</p>
<p>So what does an ASN.1 Sequence look like? Here&rsquo;s a visual:</p>
<p><a href="https://www.andrewcbancroft.com/wp-content/uploads/2017/07/ASN1Sequence.jpeg"><img src="https://www.andrewcbancroft.com/wp-content/uploads/2017/07/ASN1Sequence.jpeg" alt="ASN.1 Sequence" width="919" height="337" class="alignnone size-full wp-image-13514" srcset="https://www.andrewcbancroft.com/wp-content/uploads/2017/07/ASN1Sequence.jpeg 919w, https://www.andrewcbancroft.com/wp-content/uploads/2017/07/ASN1Sequence-300x110.jpeg 300w, https://www.andrewcbancroft.com/wp-content/uploads/2017/07/ASN1Sequence-768x282.jpeg 768w" sizes="(max-width: 919px) 100vw, 919px" /></a></p>
<p>When it comes to app receipts, ASN.1 <em>Sequences</em> are used to say, &ldquo;Hey, this series of bytes encodes <em>the bundle identifier</em> or <em>the original app version</em> or <em>some other receipt attribute</em>.&rdquo;</p>
<p>Each ASN.1 Sequence has a flag (the pink box in the visualization) to signal that the bytes that follow do, in fact, encode an ASN.1 Sequence.</p>
<p>Then, just like an ASN.1 Set, the next bytes in line (the blue box) encode how long the Sequence is. Then comes what we&rsquo;re really after in all this Set/Sequence talk:</p>
<p>The <em>type</em> of attribute (bundle identifier, for example) is encoded next in the series of bytes as an ASN.1 Integer (note that this isn&rsquo;t a Swift Int…yet…we&rsquo;ll decode it soon). Each attribute type has a unique ASN.1 Integer value, kind of like an ID. <a href="https://developer.apple.com/library/content/releasenotes/General/ValidateAppStoreReceipt/Chapters/ReceiptFields.html">Apple&rsquo;s documentation</a> is helpful in figuring out which ASN.1 Integer value maps to which receipt attribute.</p>
<p>After the attribute type comes some bytes that encode an &ldquo;attribute version&rdquo;, also as an ASN.1 Integer. At the time of this guide&rsquo;s publication, &ldquo;attribute version&rdquo; isn&rsquo;t used for anything. Nonetheless, the series of bytes right after the attribute type within the ASN.1 Sequence is reserved and will always represent the &ldquo;attribute version&rdquo;.</p>
<p>The remaining bytes in the ASN.1 Sequence encode the actual <em>value</em> of the attribute as an ASN.1 Octet String (don&rsquo;t let the word &ldquo;Octet String&rdquo; trick you into thinking that it&rsquo;s actually a String… they&rsquo;re <em>bytes</em> that we&rsquo;ll have to decode shortly…)</p>
<p>Knowing how the receipt payload is structured will help us formulate a strategy around parsing it. Let&rsquo;s imagine a simple algorithm to do it now.</p>
<p><a name="parsing-strategy" class="jump-target"></a></p>
<h2 id="receipt-parsing-strategy">Receipt parsing strategy</h2>
<p>Let&rsquo;s take it step by step. What if we approach parsing the receipt like this:</p>
<p><strong>1)</strong> Do some preliminary checks to ensure that the receipt payload is in the correct structural format (it should be an ASN.1 Set, for example).</p>
<p><strong>2)</strong> For each ASN.1 Sequence within the ASN.1 Set, check to see what type of attribute it is.</p>
<p><strong>3)</strong> Decode its Octet String value into actual, human-readable values. The decoded values would be represented by Swift Types (Int, String, Date are sufficient to cover all of the possibilities for receipts). The final decoded value depends on what <em>type</em> of attribute it is.</p>
<p><strong>4)</strong> Create and return a ParsedReceipt instance as the final product.</p>
<p>If at any point the receipt payload fails to live up to the expected structure, receipt validation will fail, and we can signal that by throwing an error.</p>
<p><a name="note-on-iap-receipts" class="jump-target"></a></p>
<h4 id="a-note-on-in-app-purchase-receipts">A note on in-app purchase receipts</h4>
<p>As we follow the receipt parsing strategy steps that I just described, there&rsquo;s going to come a point where we run into the ASN.1 Sequence that encodes the in-app purchase receipts.</p>
<p>These are special.</p>
<p>In-app purchase receipts are encoded as ASN.1 Sets (with ASN.1 Sequences within) <em>inside</em> the primary ASN.1 Set receipt payload. In other words, they&rsquo;re <em>nested</em> ASN.1 Sets within the <em>overall</em> ASN.1 Set that encodes the whole receipt. The nested Set contains the <em>in-app purchase</em> receipt attributes.</p>
<p>So in order to decode these, we&rsquo;ll have to apply the receipt parsing strategy <em>within</em> the receipt parsing strategy. Fun, huh? We&rsquo;ll only have to do it for the in-app purchase receipt attributes though.</p>
<p><a name="helper-functions" class="jump-target"></a></p>
<h2 id="preparation-step-helper-decoding-functions">Preparation step: Helper decoding functions</h2>
<p>If you saw the <code>ParsedReceipt</code> struct that I proposed earlier in the guide, you&rsquo;ll notice that there are essentially four Swift Types that the receipt attributes (and in-app purchase receipt attributes) get decoded into:</p>
<ul>
<li><code>Int?</code></li>
<li><code>String?</code></li>
<li><code>NSData?</code></li>
<li><code>Date?</code></li>
</ul>
<p><code>NSData</code> has a constructor that can work with <code>UnsafeRawPointers</code> directly, but <code>Int?</code>, <code>String?</code>, and <code>Date?</code> need some help converting from the ASN.1 versions of those Types to the <em>Swift</em> versions of those Types.</p>
<p>Let me put the code before you and follow up with what I&rsquo;m doing here:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">DecodeASN1Integer</span><span class="p">(</span><span class="n">startOfInt</span> <span class="n">intPointer</span><span class="p">:</span> <span class="kr">inout</span> <span class="nb">UnsafePointer</span><span class="p">&lt;</span><span class="nb">UInt8</span><span class="p">&gt;?,</span> <span class="n">length</span><span class="p">:</span> <span class="nb">Int</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nb">Int</span><span class="p">?</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// These will be set by ASN1_get_object</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nv">type</span> <span class="p">=</span> <span class="nb">Int32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nv">xclass</span> <span class="p">=</span> <span class="nb">Int32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nv">intLength</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">ASN1_get_object</span><span class="p">(&amp;</span><span class="n">intPointer</span><span class="p">,</span> <span class="p">&amp;</span><span class="n">intLength</span><span class="p">,</span> <span class="p">&amp;</span><span class="n">type</span><span class="p">,</span> <span class="p">&amp;</span><span class="n">xclass</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">guard</span> <span class="n">type</span> <span class="p">==</span> <span class="n">V_ASN1_INTEGER</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nv">integer</span> <span class="p">=</span> <span class="n">c2i_ASN1_INTEGER</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="p">&amp;</span><span class="n">intPointer</span><span class="p">,</span> <span class="n">intLength</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nv">result</span> <span class="p">=</span> <span class="n">ASN1_INTEGER_get</span><span class="p">(</span><span class="n">integer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ASN1_INTEGER_free</span><span class="p">(</span><span class="n">integer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">result</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">DecodeASN1String</span><span class="p">(</span><span class="n">startOfString</span> <span class="n">stringPointer</span><span class="p">:</span> <span class="kr">inout</span> <span class="nb">UnsafePointer</span><span class="p">&lt;</span><span class="nb">UInt8</span><span class="p">&gt;?,</span> <span class="n">length</span><span class="p">:</span> <span class="nb">Int</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nb">String</span><span class="p">?</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// These will be set by ASN1_get_object</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nv">type</span> <span class="p">=</span> <span class="nb">Int32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nv">xclass</span> <span class="p">=</span> <span class="nb">Int32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nv">stringLength</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ASN1_get_object</span><span class="p">(&amp;</span><span class="n">stringPointer</span><span class="p">,</span> <span class="p">&amp;</span><span class="n">stringLength</span><span class="p">,</span> <span class="p">&amp;</span><span class="n">type</span><span class="p">,</span> <span class="p">&amp;</span><span class="n">xclass</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">type</span> <span class="p">==</span> <span class="n">V_ASN1_UTF8STRING</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nv">mutableStringPointer</span> <span class="p">=</span> <span class="n">UnsafeMutableRawPointer</span><span class="p">(</span><span class="kr">mutating</span><span class="p">:</span> <span class="n">stringPointer</span><span class="p">!)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">String</span><span class="p">(</span><span class="n">bytesNoCopy</span><span class="p">:</span> <span class="n">mutableStringPointer</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="n">stringLength</span><span class="p">,</span> <span class="n">encoding</span><span class="p">:</span> <span class="nb">String</span><span class="p">.</span><span class="n">Encoding</span><span class="p">.</span><span class="n">utf8</span><span class="p">,</span> <span class="n">freeWhenDone</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">type</span> <span class="p">==</span> <span class="n">V_ASN1_IA5STRING</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nv">mutableStringPointer</span> <span class="p">=</span> <span class="n">UnsafeMutableRawPointer</span><span class="p">(</span><span class="kr">mutating</span><span class="p">:</span> <span class="n">stringPointer</span><span class="p">!)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">String</span><span class="p">(</span><span class="n">bytesNoCopy</span><span class="p">:</span> <span class="n">mutableStringPointer</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="n">stringLength</span><span class="p">,</span> <span class="n">encoding</span><span class="p">:</span> <span class="nb">String</span><span class="p">.</span><span class="n">Encoding</span><span class="p">.</span><span class="n">ascii</span><span class="p">,</span> <span class="n">freeWhenDone</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">DecodeASN1Date</span><span class="p">(</span><span class="n">startOfDate</span> <span class="n">datePointer</span><span class="p">:</span> <span class="kr">inout</span> <span class="nb">UnsafePointer</span><span class="p">&lt;</span><span class="nb">UInt8</span><span class="p">&gt;?,</span> <span class="n">length</span><span class="p">:</span> <span class="nb">Int</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Date</span><span class="p">?</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Date formatter code from https://www.objc.io/issues/17-security/receipt-validation/#parsing-the-receipt</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nv">dateFormatter</span> <span class="p">=</span> <span class="n">DateFormatter</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">dateFormatter</span><span class="p">.</span><span class="n">locale</span> <span class="p">=</span> <span class="n">Locale</span><span class="p">(</span><span class="n">identifier</span><span class="p">:</span> <span class="s">&#34;en_US_POSIX&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">dateFormatter</span><span class="p">.</span><span class="n">dateFormat</span> <span class="p">=</span> <span class="s">&#34;yyyy&#39;-&#39;MM&#39;-&#39;dd&#39;T&#39;HH&#39;:&#39;mm&#39;:&#39;ss&#39;Z&#39;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">dateFormatter</span><span class="p">.</span><span class="n">timeZone</span> <span class="p">=</span> <span class="n">TimeZone</span><span class="p">(</span><span class="n">secondsFromGMT</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="kd">let</span> <span class="nv">dateString</span> <span class="p">=</span> <span class="n">DecodeASN1String</span><span class="p">(</span><span class="n">startOfString</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">datePointer</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">dateFormatter</span><span class="p">.</span><span class="n">date</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">dateString</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
<p>Each of these decoding functions are dealing with the receipt attribute <em>value</em> portion of the ASN.1 Sequence that we&rsquo;re working on at the time. Recall the structure:<br>
<a href="https://www.andrewcbancroft.com/wp-content/uploads/2017/07/ASN1Sequence.jpeg"><img src="https://www.andrewcbancroft.com/wp-content/uploads/2017/07/ASN1Sequence.jpeg" alt="ASN.1 Sequence" width="919" height="337" class="alignnone size-full wp-image-13514" srcset="https://www.andrewcbancroft.com/wp-content/uploads/2017/07/ASN1Sequence.jpeg 919w, https://www.andrewcbancroft.com/wp-content/uploads/2017/07/ASN1Sequence-300x110.jpeg 300w, https://www.andrewcbancroft.com/wp-content/uploads/2017/07/ASN1Sequence-768x282.jpeg 768w" sizes="(max-width: 919px) 100vw, 919px" /></a></p>
<p>So we take in a pointer that&rsquo;s pointing <em>to</em> the start of one of the attribute <em>values</em> (a yellow box). The yellow box&rsquo;s ASN.1 Octet String encodes either an integer, a string, or a date. (Okay, technically I guess you could include NSData, but this doesn&rsquo;t need to be &ldquo;decoded&rdquo; really. And the in-app purchase receipts will be parsed and decoded into the stated Types as well, so it all boils down to the three I just mentioned…thus the reason for only three helper functions).</p>
<p>The strategy for the first two functions is basically to take what we&rsquo;re pointing to, and call <code>ASN1_get_object</code>.</p>
<p>This function call gets us enough information to decode the bytes from the start of the object to the end of the object into either an <code>Int?</code> or a <code>String?</code>. If it fails, <code>nil</code> is returned.</p>
<p>Decoding dates simply involves initializing a <code>DateFormatter</code> with the appropriate locale and date format. The datePointer parameter actually points to an encoded <em>string</em>, so the strategy is to use the <code>DecodeASN1String</code> function we made, and pass the date string to the date formatter.</p>
<p>So long as the string can be decoded, the date formatter instance is used to create an actual <code>Date?</code> instance and return it. Otherwise, <code>nil</code> is returned.</p>
<p><a name="handling-error-conditions" class="jump-target"></a></p>
<h2 id="handling-error-conditions">Handling error conditions</h2>
<p>The kinds of errors that can occur when parsing the receipt payload all have to do with unexpected structure.</p>
<p>For example, if we&rsquo;re expecting to be stepping through an ASN.1 Payload or an ASN.1 Sequence but instead find that it&rsquo;s not what we expect, this is a situation where reeipt validation should fail, because there&rsquo;s no way to decode the receipt attributes if the bytes of the payload don&rsquo;t conform to the expected structure.</p>
<p>In situations where the receipt payload or one of its in-app purchase receipt payloads is &ldquo;malformed&rdquo; in some way, we can throw an <code>Error</code>.</p>
<p>I&rsquo;ve highlighted two new <code>ReceiptValidationError</code> cases here:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="kd">enum</span> <span class="nc">ReceiptValidationError</span> <span class="p">:</span> <span class="n">Error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="n">couldNotFindReceipt</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="n">emptyReceiptContents</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="n">receiptNotSigned</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="n">appleRootCertificateNotFound</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="n">receiptSignatureInvalid</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="n">malformedReceipt</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="n">malformedInAppPurchaseReceipt</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
<p><a name="implementing-receipt-parser" class="jump-target"></a></p>
<h2 id="implenting-receiptparser">Implenting ReceiptParser</h2>
<p>OK! We&rsquo;ve got a few helper functions to decode the receipt attributes, and we&rsquo;ve got some <code>ReceiptValidationError</code> cases to throw in case parsing fails.</p>
<p>At a very high level, the ReceiptParser will take the following skeletal structure:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="kd">struct</span> <span class="nc">ReceiptParser</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">func</span> <span class="nf">parse</span><span class="p">(</span><span class="kc">_</span> <span class="n">PKCS7Container</span><span class="p">:</span> <span class="nb">UnsafeMutablePointer</span><span class="p">&lt;</span><span class="n">PKCS7</span><span class="p">&gt;)</span> <span class="kr">throws</span> <span class="p">-&gt;</span> <span class="n">ParsedReceipt</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nv">bundleIdentifier</span><span class="p">:</span> <span class="nb">String</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nv">bundleIdData</span><span class="p">:</span> <span class="n">NSData</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nv">appVersion</span><span class="p">:</span> <span class="nb">String</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nv">opaqueValue</span><span class="p">:</span> <span class="n">NSData</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nv">sha1Hash</span><span class="p">:</span> <span class="n">NSData</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nv">inAppPurchaseReceipts</span> <span class="p">=</span> <span class="p">[</span><span class="n">ParsedInAppPurchaseReceipt</span><span class="p">]()</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nv">originalAppVersion</span><span class="p">:</span> <span class="nb">String</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nv">receiptCreationDate</span><span class="p">:</span> <span class="n">Date</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nv">expirationDate</span><span class="p">:</span> <span class="n">Date</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// Parse the receipt, setting each variable</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ParsedReceipt</span><span class="p">(</span><span class="n">bundleIdentifier</span><span class="p">:</span> <span class="n">bundleIdentifier</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="n">bundleIdData</span><span class="p">:</span> <span class="n">bundleIdData</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="n">appVersion</span><span class="p">:</span> <span class="n">appVersion</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="n">opaqueValue</span><span class="p">:</span> <span class="n">opaqueValue</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="n">sha1Hash</span><span class="p">:</span> <span class="n">sha1Hash</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="n">inAppPurchaseReceipts</span><span class="p">:</span> <span class="n">inAppPurchaseReceipts</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="n">originalAppVersion</span><span class="p">:</span> <span class="n">originalAppVersion</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="n">receiptCreationDate</span><span class="p">:</span> <span class="n">receiptCreationDate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="n">expirationDate</span><span class="p">:</span> <span class="n">expirationDate</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kd">func</span> <span class="nf">parseInAppPurchaseReceipt</span><span class="p">(</span><span class="n">currentInAppPurchaseASN1PayloadLocation</span><span class="p">:</span> <span class="kr">inout</span> <span class="nb">UnsafePointer</span><span class="p">&lt;</span><span class="nb">UInt8</span><span class="p">&gt;?,</span> <span class="n">payloadLength</span><span class="p">:</span> <span class="nb">Int</span><span class="p">)</span> <span class="kr">throws</span> <span class="p">-&gt;</span> <span class="n">ParsedInAppPurchaseReceipt</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nv">quantity</span><span class="p">:</span> <span class="nb">Int</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nv">productIdentifier</span><span class="p">:</span> <span class="nb">String</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nv">transactionIdentifier</span><span class="p">:</span> <span class="nb">String</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nv">originalTransactionIdentifier</span><span class="p">:</span> <span class="nb">String</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nv">purchaseDate</span><span class="p">:</span> <span class="n">Date</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nv">originalPurchaseDate</span><span class="p">:</span> <span class="n">Date</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nv">subscriptionExpirationDate</span><span class="p">:</span> <span class="n">Date</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nv">cancellationDate</span><span class="p">:</span> <span class="n">Date</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nv">webOrderLineItemId</span><span class="p">:</span> <span class="nb">Int</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// Parse the in-app purchase receipt, setting each variable</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ParsedInAppPurchaseReceipt</span><span class="p">(</span><span class="n">quantity</span><span class="p">:</span> <span class="n">quantity</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                          <span class="n">productIdentifier</span><span class="p">:</span> <span class="n">productIdentifier</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                          <span class="n">transactionIdentifier</span><span class="p">:</span> <span class="n">transactionIdentifier</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                          <span class="n">originalTransactionIdentifier</span><span class="p">:</span> <span class="n">originalTransactionIdentifier</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                          <span class="n">purchaseDate</span><span class="p">:</span> <span class="n">purchaseDate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                          <span class="n">originalPurchaseDate</span><span class="p">:</span> <span class="n">originalPurchaseDate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                          <span class="n">subscriptionExpirationDate</span><span class="p">:</span> <span class="n">subscriptionExpirationDate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                          <span class="n">cancellationDate</span><span class="p">:</span> <span class="n">cancellationDate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                          <span class="n">webOrderLineItemId</span><span class="p">:</span> <span class="n">webOrderLineItemId</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
<p>So a total of two functions: one to parse the overall receipt, and one to parse each in-app purchase receipt nested <em>within</em> the overall receipt.</p>
<p>Now comes the hard part. Actually doing all the decoding. Don&rsquo;t forget the <a href="#parsing-strategy">strategy</a> we&rsquo;re going to take! That&rsquo;ll help you walk through this code without getting insanely overwhelmed (hopefully).</p>
<p><a name="parse-function-implementation" class="jump-target"></a></p>
<h4 id="parse-function-implementation"><code>parse</code> function implementation</h4>
<p>First, the implementation of <code>parse(_:)</code> with comments throughout to help you find where each step of the <a href="#parsing-strategy">strategy</a> is being implemented:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">parse</span><span class="p">(</span><span class="kc">_</span> <span class="n">PKCS7Container</span><span class="p">:</span> <span class="nb">UnsafeMutablePointer</span><span class="p">&lt;</span><span class="n">PKCS7</span><span class="p">&gt;)</span> <span class="kr">throws</span> <span class="p">-&gt;</span> <span class="n">ParsedReceipt</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nv">bundleIdentifier</span><span class="p">:</span> <span class="nb">String</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nv">bundleIdData</span><span class="p">:</span> <span class="n">NSData</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nv">appVersion</span><span class="p">:</span> <span class="nb">String</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nv">opaqueValue</span><span class="p">:</span> <span class="n">NSData</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nv">sha1Hash</span><span class="p">:</span> <span class="n">NSData</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nv">inAppPurchaseReceipts</span> <span class="p">=</span> <span class="p">[</span><span class="n">ParsedInAppPurchaseReceipt</span><span class="p">]()</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nv">originalAppVersion</span><span class="p">:</span> <span class="nb">String</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nv">receiptCreationDate</span><span class="p">:</span> <span class="n">Date</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nv">expirationDate</span><span class="p">:</span> <span class="n">Date</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// Strategy Step 1: Preliminary structure checks</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Must have data to work with</span>
</span></span><span class="line"><span class="cl">    <span class="k">guard</span> <span class="kd">let</span> <span class="nv">contents</span> <span class="p">=</span> <span class="n">PKCS7Container</span><span class="p">.</span><span class="n">pointee</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">sign</span><span class="p">.</span><span class="n">pointee</span><span class="p">.</span><span class="n">contents</span><span class="p">,</span> <span class="kd">let</span> <span class="nv">octets</span> <span class="p">=</span> <span class="n">contents</span><span class="p">.</span><span class="n">pointee</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">data</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="n">ReceiptValidationError</span><span class="p">.</span><span class="n">malformedReceipt</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// Determine the start and end of the receipt payload</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nv">currentASN1PayloadLocation</span> <span class="p">=</span> <span class="nb">UnsafePointer</span><span class="p">(</span><span class="n">octets</span><span class="p">.</span><span class="n">pointee</span><span class="p">.</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nv">endOfPayload</span> <span class="p">=</span> <span class="n">currentASN1PayloadLocation</span><span class="p">!.</span><span class="n">advanced</span><span class="p">(</span><span class="n">by</span><span class="p">:</span> <span class="nb">Int</span><span class="p">(</span><span class="n">octets</span><span class="p">.</span><span class="n">pointee</span><span class="p">.</span><span class="n">length</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nv">type</span> <span class="p">=</span> <span class="nb">Int32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nv">xclass</span> <span class="p">=</span> <span class="nb">Int32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nv">length</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">ASN1_get_object</span><span class="p">(&amp;</span><span class="n">currentASN1PayloadLocation</span><span class="p">,</span> <span class="p">&amp;</span><span class="n">length</span><span class="p">,</span> <span class="p">&amp;</span><span class="n">type</span><span class="p">,</span> <span class="p">&amp;</span><span class="n">xclass</span><span class="p">,</span><span class="nb">Int</span><span class="p">(</span><span class="n">octets</span><span class="p">.</span><span class="n">pointee</span><span class="p">.</span><span class="n">length</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// Payload must be an ASN1 Set</span>
</span></span><span class="line"><span class="cl">    <span class="k">guard</span> <span class="n">type</span> <span class="p">==</span> <span class="n">V_ASN1_SET</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="n">ReceiptValidationError</span><span class="p">.</span><span class="n">malformedReceipt</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// Decode Payload</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Strategy Step 2: Walk through payload (ASN1 Set) and parse each ASN1 Sequence </span>
</span></span><span class="line"><span class="cl">    <span class="c1">// within (ASN1 Sets contain one or more ASN1 Sequences)</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="n">currentASN1PayloadLocation</span><span class="p">!</span> <span class="o">&lt;</span> <span class="n">endOfPayload</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// Get next ASN1 Sequence</span>
</span></span><span class="line"><span class="cl">        <span class="n">ASN1_get_object</span><span class="p">(</span><span class="o">&amp;</span><span class="p">#</span><span class="mi">038</span><span class="p">;</span><span class="n">currentASN1PayloadLocation</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">#</span><span class="mi">038</span><span class="p">;</span><span class="n">length</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">#</span><span class="mi">038</span><span class="p">;</span><span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">#</span><span class="mi">038</span><span class="p">;</span><span class="n">xclass</span><span class="p">,</span> <span class="n">currentASN1PayloadLocation</span><span class="p">!.</span><span class="bp">distance</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="n">endOfPayload</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// ASN1 Object type must be an ASN1 Sequence</span>
</span></span><span class="line"><span class="cl">        <span class="k">guard</span> <span class="n">type</span> <span class="p">==</span> <span class="n">V_ASN1_SEQUENCE</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="n">ReceiptValidationError</span><span class="p">.</span><span class="n">malformedReceipt</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// Attribute type of ASN1 Sequence must be an Integer</span>
</span></span><span class="line"><span class="cl">        <span class="k">guard</span> <span class="kd">let</span> <span class="nv">attributeType</span> <span class="p">=</span> <span class="n">DecodeASN1Integer</span><span class="p">(</span><span class="n">startOfInt</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">#</span><span class="mi">038</span><span class="p">;</span><span class="n">currentASN1PayloadLocation</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="n">currentASN1PayloadLocation</span><span class="p">!.</span><span class="bp">distance</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="n">endOfPayload</span><span class="p">))</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="n">ReceiptValidationError</span><span class="p">.</span><span class="n">malformedReceipt</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// Attribute version of ASN1 Sequence must be an Integer</span>
</span></span><span class="line"><span class="cl">        <span class="k">guard</span> <span class="n">DecodeASN1Integer</span><span class="p">(</span><span class="n">startOfInt</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">#</span><span class="mi">038</span><span class="p">;</span><span class="n">currentASN1PayloadLocation</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="n">currentASN1PayloadLocation</span><span class="p">!.</span><span class="bp">distance</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="n">endOfPayload</span><span class="p">))</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="n">ReceiptValidationError</span><span class="p">.</span><span class="n">malformedReceipt</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// Get ASN1 Sequence value</span>
</span></span><span class="line"><span class="cl">        <span class="n">ASN1_get_object</span><span class="p">(</span><span class="o">&amp;</span><span class="p">#</span><span class="mi">038</span><span class="p">;</span><span class="n">currentASN1PayloadLocation</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">#</span><span class="mi">038</span><span class="p">;</span><span class="n">length</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">#</span><span class="mi">038</span><span class="p">;</span><span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">#</span><span class="mi">038</span><span class="p">;</span><span class="n">xclass</span><span class="p">,</span> <span class="n">currentASN1PayloadLocation</span><span class="p">!.</span><span class="bp">distance</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="n">endOfPayload</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// ASN1 Sequence value must be an ASN1 Octet String</span>
</span></span><span class="line"><span class="cl">        <span class="k">guard</span> <span class="n">type</span> <span class="p">==</span> <span class="n">V_ASN1_OCTET_STRING</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="n">ReceiptValidationError</span><span class="p">.</span><span class="n">malformedReceipt</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// Strategy Step 3: Decode attributes</span>
</span></span><span class="line"><span class="cl">        <span class="k">switch</span> <span class="n">attributeType</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="kd">var</span> <span class="nv">startOfBundleId</span> <span class="p">=</span> <span class="n">currentASN1PayloadLocation</span>
</span></span><span class="line"><span class="cl">            <span class="n">bundleIdData</span> <span class="p">=</span> <span class="n">NSData</span><span class="p">(</span><span class="n">bytes</span><span class="p">:</span> <span class="n">startOfBundleId</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="n">length</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">bundleIdentifier</span> <span class="p">=</span> <span class="n">DecodeASN1String</span><span class="p">(</span><span class="n">startOfString</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">#</span><span class="mi">038</span><span class="p">;</span><span class="n">startOfBundleId</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="n">length</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">3</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="kd">var</span> <span class="nv">startOfAppVersion</span> <span class="p">=</span> <span class="n">currentASN1PayloadLocation</span>
</span></span><span class="line"><span class="cl">            <span class="n">appVersion</span> <span class="p">=</span> <span class="n">DecodeASN1String</span><span class="p">(</span><span class="n">startOfString</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">#</span><span class="mi">038</span><span class="p">;</span><span class="n">startOfAppVersion</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="n">length</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">4</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="kd">let</span> <span class="nv">startOfOpaqueValue</span> <span class="p">=</span> <span class="n">currentASN1PayloadLocation</span>
</span></span><span class="line"><span class="cl">            <span class="n">opaqueValue</span> <span class="p">=</span> <span class="n">NSData</span><span class="p">(</span><span class="n">bytes</span><span class="p">:</span> <span class="n">startOfOpaqueValue</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="n">length</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">5</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="kd">let</span> <span class="nv">startOfSha1Hash</span> <span class="p">=</span> <span class="n">currentASN1PayloadLocation</span>
</span></span><span class="line"><span class="cl">            <span class="n">sha1Hash</span> <span class="p">=</span> <span class="n">NSData</span><span class="p">(</span><span class="n">bytes</span><span class="p">:</span> <span class="n">startOfSha1Hash</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="n">length</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">17</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="kd">var</span> <span class="nv">startOfInAppPurchaseReceipt</span> <span class="p">=</span> <span class="n">currentASN1PayloadLocation</span>
</span></span><span class="line"><span class="cl">            <span class="kd">let</span> <span class="nv">iapReceipt</span> <span class="p">=</span> <span class="k">try</span> <span class="n">parseInAppPurchaseReceipt</span><span class="p">(</span><span class="n">currentInAppPurchaseASN1PayloadLocation</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">#</span><span class="mi">038</span><span class="p">;</span><span class="n">startOfInAppPurchaseReceipt</span><span class="p">,</span> <span class="n">payloadLength</span><span class="p">:</span> <span class="n">length</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">inAppPurchaseReceipts</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">iapReceipt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">12</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="kd">var</span> <span class="nv">startOfReceiptCreationDate</span> <span class="p">=</span> <span class="n">currentASN1PayloadLocation</span>
</span></span><span class="line"><span class="cl">            <span class="n">receiptCreationDate</span> <span class="p">=</span> <span class="n">DecodeASN1Date</span><span class="p">(</span><span class="n">startOfDate</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">#</span><span class="mi">038</span><span class="p">;</span><span class="n">startOfReceiptCreationDate</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="n">length</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">19</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="kd">var</span> <span class="nv">startOfOriginalAppVersion</span> <span class="p">=</span> <span class="n">currentASN1PayloadLocation</span>
</span></span><span class="line"><span class="cl">            <span class="n">originalAppVersion</span> <span class="p">=</span> <span class="n">DecodeASN1String</span><span class="p">(</span><span class="n">startOfString</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">#</span><span class="mi">038</span><span class="p">;</span><span class="n">startOfOriginalAppVersion</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="n">length</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">21</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="kd">var</span> <span class="nv">startOfExpirationDate</span> <span class="p">=</span> <span class="n">currentASN1PayloadLocation</span>
</span></span><span class="line"><span class="cl">            <span class="n">expirationDate</span> <span class="p">=</span> <span class="n">DecodeASN1Date</span><span class="p">(</span><span class="n">startOfDate</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">#</span><span class="mi">038</span><span class="p">;</span><span class="n">startOfExpirationDate</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="n">length</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">currentASN1PayloadLocation</span> <span class="p">=</span> <span class="n">currentASN1PayloadLocation</span><span class="p">?.</span><span class="n">advanced</span><span class="p">(</span><span class="n">by</span><span class="p">:</span> <span class="n">length</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// Strategy Step 4: Return ParsedReceipt</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ParsedReceipt</span><span class="p">(</span><span class="n">bundleIdentifier</span><span class="p">:</span> <span class="n">bundleIdentifier</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">bundleIdData</span><span class="p">:</span> <span class="n">bundleIdData</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">appVersion</span><span class="p">:</span> <span class="n">appVersion</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">opaqueValue</span><span class="p">:</span> <span class="n">opaqueValue</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">sha1Hash</span><span class="p">:</span> <span class="n">sha1Hash</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">inAppPurchaseReceipts</span><span class="p">:</span> <span class="n">inAppPurchaseReceipts</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">originalAppVersion</span><span class="p">:</span> <span class="n">originalAppVersion</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">receiptCreationDate</span><span class="p">:</span> <span class="n">receiptCreationDate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">expirationDate</span><span class="p">:</span> <span class="n">expirationDate</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
<p>Aside from the work with pointers and the Open SSL function names, the strategy is pretty straight-forward when you look it from a bird&rsquo;s-eye point of view.</p>
<p>Once again, if you&rsquo;re curious about how I knew to map each <code>case</code> within the <code>switch</code> to the correct receipt attribute, I simply got them from <a href="https://developer.apple.com/library/content/releasenotes/General/ValidateAppStoreReceipt/Chapters/ReceiptFields.html">Apple&rsquo;s documentation</a>.</p>
<p><a name="parse-in-app-purchase-receipt-implementation" class="jump-target"></a></p>
<h4 id="parseinapppurchaserectipt-function-implementation"><code>parseInAppPurchaseRectipt</code> function implementation</h4>
<p>Now it&rsquo;s time to see how to parse an in-app purchase receipt payload. Take a look:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">parseInAppPurchaseReceipt</span><span class="p">(</span><span class="n">currentInAppPurchaseASN1PayloadLocation</span><span class="p">:</span> <span class="kr">inout</span> <span class="nb">UnsafePointer</span><span class="p">&lt;</span><span class="nb">UInt8</span><span class="p">&gt;?,</span> <span class="n">payloadLength</span><span class="p">:</span> <span class="nb">Int</span><span class="p">)</span> <span class="kr">throws</span> <span class="p">-&gt;</span> <span class="n">ParsedInAppPurchaseReceipt</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nv">quantity</span><span class="p">:</span> <span class="nb">Int</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nv">productIdentifier</span><span class="p">:</span> <span class="nb">String</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nv">transactionIdentifier</span><span class="p">:</span> <span class="nb">String</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nv">originalTransactionIdentifier</span><span class="p">:</span> <span class="nb">String</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nv">purchaseDate</span><span class="p">:</span> <span class="n">Date</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nv">originalPurchaseDate</span><span class="p">:</span> <span class="n">Date</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nv">subscriptionExpirationDate</span><span class="p">:</span> <span class="n">Date</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nv">cancellationDate</span><span class="p">:</span> <span class="n">Date</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nv">webOrderLineItemId</span><span class="p">:</span> <span class="nb">Int</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// Find the end of the in-app purchase receipt payload</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nv">endOfPayload</span> <span class="p">=</span> <span class="n">currentInAppPurchaseASN1PayloadLocation</span><span class="p">!.</span><span class="n">advanced</span><span class="p">(</span><span class="n">by</span><span class="p">:</span> <span class="n">payloadLength</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nv">type</span> <span class="p">=</span> <span class="nb">Int32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nv">xclass</span> <span class="p">=</span> <span class="nb">Int32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nv">length</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">ASN1_get_object</span><span class="p">(&amp;</span><span class="n">currentInAppPurchaseASN1PayloadLocation</span><span class="p">,</span> <span class="p">&amp;</span><span class="n">length</span><span class="p">,</span> <span class="p">&amp;</span><span class="n">type</span><span class="p">,</span> <span class="p">&amp;</span><span class="n">xclass</span><span class="p">,</span> <span class="n">payloadLength</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// Payload must be an ASN1 Set</span>
</span></span><span class="line"><span class="cl">    <span class="k">guard</span> <span class="n">type</span> <span class="p">==</span> <span class="n">V_ASN1_SET</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="n">ReceiptValidationError</span><span class="p">.</span><span class="n">malformedInAppPurchaseReceipt</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// Decode Payload</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Step through payload (ASN1 Set) and parse each ASN1 Sequence within (ASN1 Sets contain one or more ASN1 Sequences)</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="n">currentInAppPurchaseASN1PayloadLocation</span><span class="p">!</span> <span class="o">&lt;</span> <span class="n">endOfPayload</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// Get next ASN1 Sequence</span>
</span></span><span class="line"><span class="cl">        <span class="n">ASN1_get_object</span><span class="p">(</span><span class="o">&amp;</span><span class="p">#</span><span class="mi">038</span><span class="p">;</span><span class="n">currentInAppPurchaseASN1PayloadLocation</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">#</span><span class="mi">038</span><span class="p">;</span><span class="n">length</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">#</span><span class="mi">038</span><span class="p">;</span><span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">#</span><span class="mi">038</span><span class="p">;</span><span class="n">xclass</span><span class="p">,</span> <span class="n">currentInAppPurchaseASN1PayloadLocation</span><span class="p">!.</span><span class="bp">distance</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="n">endOfPayload</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// ASN1 Object type must be an ASN1 Sequence</span>
</span></span><span class="line"><span class="cl">        <span class="k">guard</span> <span class="n">type</span> <span class="p">==</span> <span class="n">V_ASN1_SEQUENCE</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="n">ReceiptValidationError</span><span class="p">.</span><span class="n">malformedInAppPurchaseReceipt</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// Attribute type of ASN1 Sequence must be an Integer</span>
</span></span><span class="line"><span class="cl">        <span class="k">guard</span> <span class="kd">let</span> <span class="nv">attributeType</span> <span class="p">=</span> <span class="n">DecodeASN1Integer</span><span class="p">(</span><span class="n">startOfInt</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">#</span><span class="mi">038</span><span class="p">;</span><span class="n">currentInAppPurchaseASN1PayloadLocation</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="n">currentInAppPurchaseASN1PayloadLocation</span><span class="p">!.</span><span class="bp">distance</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="n">endOfPayload</span><span class="p">))</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="n">ReceiptValidationError</span><span class="p">.</span><span class="n">malformedInAppPurchaseReceipt</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// Attribute version of ASN1 Sequence must be an Integer</span>
</span></span><span class="line"><span class="cl">        <span class="k">guard</span> <span class="n">DecodeASN1Integer</span><span class="p">(</span><span class="n">startOfInt</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">#</span><span class="mi">038</span><span class="p">;</span><span class="n">currentInAppPurchaseASN1PayloadLocation</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="n">currentInAppPurchaseASN1PayloadLocation</span><span class="p">!.</span><span class="bp">distance</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="n">endOfPayload</span><span class="p">))</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="n">ReceiptValidationError</span><span class="p">.</span><span class="n">malformedInAppPurchaseReceipt</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// Get ASN1 Sequence value</span>
</span></span><span class="line"><span class="cl">        <span class="n">ASN1_get_object</span><span class="p">(</span><span class="o">&amp;</span><span class="p">#</span><span class="mi">038</span><span class="p">;</span><span class="n">currentInAppPurchaseASN1PayloadLocation</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">#</span><span class="mi">038</span><span class="p">;</span><span class="n">length</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">#</span><span class="mi">038</span><span class="p">;</span><span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">#</span><span class="mi">038</span><span class="p">;</span><span class="n">xclass</span><span class="p">,</span> <span class="n">currentInAppPurchaseASN1PayloadLocation</span><span class="p">!.</span><span class="bp">distance</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="n">endOfPayload</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// ASN1 Sequence value must be an ASN1 Octet String</span>
</span></span><span class="line"><span class="cl">        <span class="k">guard</span> <span class="n">type</span> <span class="p">==</span> <span class="n">V_ASN1_OCTET_STRING</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="n">ReceiptValidationError</span><span class="p">.</span><span class="n">malformedInAppPurchaseReceipt</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// Decode attributes</span>
</span></span><span class="line"><span class="cl">        <span class="k">switch</span> <span class="n">attributeType</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">1701</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="kd">var</span> <span class="nv">startOfQuantity</span> <span class="p">=</span> <span class="n">currentInAppPurchaseASN1PayloadLocation</span>
</span></span><span class="line"><span class="cl">            <span class="n">quantity</span> <span class="p">=</span> <span class="n">DecodeASN1Integer</span><span class="p">(</span><span class="n">startOfInt</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">#</span><span class="mi">038</span><span class="p">;</span><span class="n">startOfQuantity</span> <span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="n">length</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">1702</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="kd">var</span> <span class="nv">startOfProductIdentifier</span> <span class="p">=</span> <span class="n">currentInAppPurchaseASN1PayloadLocation</span>
</span></span><span class="line"><span class="cl">            <span class="n">productIdentifier</span> <span class="p">=</span> <span class="n">DecodeASN1String</span><span class="p">(</span><span class="n">startOfString</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">#</span><span class="mi">038</span><span class="p">;</span><span class="n">startOfProductIdentifier</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="n">length</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">1703</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="kd">var</span> <span class="nv">startOfTransactionIdentifier</span> <span class="p">=</span> <span class="n">currentInAppPurchaseASN1PayloadLocation</span>
</span></span><span class="line"><span class="cl">            <span class="n">transactionIdentifier</span> <span class="p">=</span> <span class="n">DecodeASN1String</span><span class="p">(</span><span class="n">startOfString</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">#</span><span class="mi">038</span><span class="p">;</span><span class="n">startOfTransactionIdentifier</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="n">length</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">1705</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="kd">var</span> <span class="nv">startOfOriginalTransactionIdentifier</span> <span class="p">=</span> <span class="n">currentInAppPurchaseASN1PayloadLocation</span>
</span></span><span class="line"><span class="cl">            <span class="n">originalTransactionIdentifier</span> <span class="p">=</span> <span class="n">DecodeASN1String</span><span class="p">(</span><span class="n">startOfString</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">#</span><span class="mi">038</span><span class="p">;</span><span class="n">startOfOriginalTransactionIdentifier</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="n">length</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">1704</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="kd">var</span> <span class="nv">startOfPurchaseDate</span> <span class="p">=</span> <span class="n">currentInAppPurchaseASN1PayloadLocation</span>
</span></span><span class="line"><span class="cl">            <span class="n">purchaseDate</span> <span class="p">=</span> <span class="n">DecodeASN1Date</span><span class="p">(</span><span class="n">startOfDate</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">#</span><span class="mi">038</span><span class="p">;</span><span class="n">startOfPurchaseDate</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="n">length</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">1706</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="kd">var</span> <span class="nv">startOfOriginalPurchaseDate</span> <span class="p">=</span> <span class="n">currentInAppPurchaseASN1PayloadLocation</span>
</span></span><span class="line"><span class="cl">            <span class="n">originalPurchaseDate</span> <span class="p">=</span> <span class="n">DecodeASN1Date</span><span class="p">(</span><span class="n">startOfDate</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">#</span><span class="mi">038</span><span class="p">;</span><span class="n">startOfOriginalPurchaseDate</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="n">length</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">1708</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="kd">var</span> <span class="nv">startOfSubscriptionExpirationDate</span> <span class="p">=</span> <span class="n">currentInAppPurchaseASN1PayloadLocation</span>
</span></span><span class="line"><span class="cl">            <span class="n">subscriptionExpirationDate</span> <span class="p">=</span> <span class="n">DecodeASN1Date</span><span class="p">(</span><span class="n">startOfDate</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">#</span><span class="mi">038</span><span class="p">;</span><span class="n">startOfSubscriptionExpirationDate</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="n">length</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">1712</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="kd">var</span> <span class="nv">startOfCancellationDate</span> <span class="p">=</span> <span class="n">currentInAppPurchaseASN1PayloadLocation</span>
</span></span><span class="line"><span class="cl">            <span class="n">cancellationDate</span> <span class="p">=</span> <span class="n">DecodeASN1Date</span><span class="p">(</span><span class="n">startOfDate</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">#</span><span class="mi">038</span><span class="p">;</span><span class="n">startOfCancellationDate</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="n">length</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">1711</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="kd">var</span> <span class="nv">startOfWebOrderLineItemId</span> <span class="p">=</span> <span class="n">currentInAppPurchaseASN1PayloadLocation</span>
</span></span><span class="line"><span class="cl">            <span class="n">webOrderLineItemId</span> <span class="p">=</span> <span class="n">DecodeASN1Integer</span><span class="p">(</span><span class="n">startOfInt</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">#</span><span class="mi">038</span><span class="p">;</span><span class="n">startOfWebOrderLineItemId</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="n">length</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">currentInAppPurchaseASN1PayloadLocation</span> <span class="p">=</span> <span class="n">currentInAppPurchaseASN1PayloadLocation</span><span class="p">!.</span><span class="n">advanced</span><span class="p">(</span><span class="n">by</span><span class="p">:</span> <span class="n">length</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ParsedInAppPurchaseReceipt</span><span class="p">(</span><span class="n">quantity</span><span class="p">:</span> <span class="n">quantity</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">productIdentifier</span><span class="p">:</span> <span class="n">productIdentifier</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">transactionIdentifier</span><span class="p">:</span> <span class="n">transactionIdentifier</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">originalTransactionIdentifier</span><span class="p">:</span> <span class="n">originalTransactionIdentifier</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">purchaseDate</span><span class="p">:</span> <span class="n">purchaseDate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">originalPurchaseDate</span><span class="p">:</span> <span class="n">originalPurchaseDate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">subscriptionExpirationDate</span><span class="p">:</span> <span class="n">subscriptionExpirationDate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">cancellationDate</span><span class="p">:</span> <span class="n">cancellationDate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">webOrderLineItemId</span><span class="p">:</span> <span class="n">webOrderLineItemId</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
<p>As you can see, parsing an in-app purchase receipt uses the same strategy as parsing the overall receipt does.</p>
<p>A receipt may contain zero or more in-app purchase receipts, so this function may get called zero, one, or many times, depending on what your app offers as in-app purchases, and of course, what your users have actually purchased.</p>
<p><a name="final-receipt-parser" class="jump-target"></a></p>
<h2 id="final-receiptparser">Final <code>ReceiptParser</code></h2>
<p>I realize that breaking the code apart like I&rsquo;ve done is good for teaching purposes, but perhaps not so much for &ldquo;I just wanna copy-paste and <em>use</em> this&rdquo; purposes.</p>
<p>I&rsquo;ll spare you having to scroll through <em>all</em> that code again. If you&rsquo;d like to see the full <code>ReceiptParser</code>, <a href="https://github.com/andrewcbancroft/SwiftyLocalReceiptValidator">check out the Swifty Local Receipt Validator repo on GitHub</a>.</p>
<p><a name="using-receipt-parser" class="jump-target"></a></p>
<h2 id="using-receiptparser">Using <code>ReceiptParser</code></h2>
<p>I initialize an instance of <code>ReceiptParser</code> in my <a href="https://www.andrewcbancroft.com/2015/10/13/loading-a-receipt-for-validation-with-swift/#receipt-validator"><code>ReceiptValidator</code> struct</a>, and then call the <code>parse(_:)</code> function from <code>validateReceipt()</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="kd">enum</span> <span class="nc">ReceiptValidationResult</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="n">success</span><span class="p">(</span><span class="n">ParsedReceipt</span><span class="p">)</span> <span class="c1">// Now has ParsedReceipt for an associated value</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="n">error</span><span class="p">(</span><span class="n">ReceiptValidationError</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">struct</span> <span class="nc">ReceiptValidator</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nv">receiptLoader</span> <span class="p">=</span> <span class="n">ReceiptLoader</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nv">receiptExtractor</span> <span class="p">=</span> <span class="n">ReceiptExtractor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nv">receiptSignatureValidator</span> <span class="p">=</span> <span class="n">ReceiptSignatureValidator</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nv">receiptParser</span> <span class="p">=</span> <span class="n">ReceiptParser</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kd">func</span> <span class="nf">validateReceipt</span><span class="p">()</span> <span class="p">-&gt;</span> <span class="n">ReceiptValidationResult</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">let</span> <span class="nv">receiptData</span> <span class="p">=</span> <span class="k">try</span> <span class="n">receiptLoader</span><span class="p">.</span><span class="n">loadReceipt</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="kd">let</span> <span class="nv">receiptContainer</span> <span class="p">=</span> <span class="k">try</span> <span class="n">receiptExtractor</span><span class="p">.</span><span class="n">extractPKCS7Container</span><span class="p">(</span><span class="n">receiptData</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="n">receiptSignatureValidator</span><span class="p">.</span><span class="n">checkSignaturePresence</span><span class="p">(</span><span class="n">receiptContainer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="n">receiptSignatureValidator</span><span class="p">.</span><span class="n">checkSignatureAuthenticity</span><span class="p">(</span><span class="n">receiptContainer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="kd">let</span> <span class="nv">parsedReceipt</span> <span class="p">=</span> <span class="k">try</span> <span class="n">receiptParser</span><span class="p">.</span><span class="n">parse</span><span class="p">(</span><span class="n">receiptContainer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="n">parsedReceipt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span> <span class="k">as</span><span class="p">!</span> <span class="n">ReceiptValidationError</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
<p><a name="preparing-to-finish-receipt-validation" class="jump-target"></a></p>
<h2 id="preparing-to-finish-receipt-validation">Preparing to finish receipt validation!</h2>
<p>What a journey this has been! We&rsquo;re <em>almost done</em> with this receipt validation process.</p>
<p>What&rsquo;s left? After this guide, you still need to&hellip;</p>
<ul>
<li><a href="https://www.andrewcbancroft.com/2017/07/31/finalizing-receipt-validation-in-swift-computing-a-guid-hash/">Compute the GUID hash of your app</a> to compare with the hash that&rsquo;s found within the receipt.</li>
<li>You&rsquo;ll also have to inspect the receipt data to perform any app-specific verification steps.</li>
</ul>
<p>We&rsquo;re that much closer now though! See you next time.</p>
<p><a name="related" class="jump-target"></a></p>
<div class="resources">
  <div class="resources-header">
    You might also enjoy...
  </div>
  <ul class="resources-content">
    <li>
      <i class="fa fa-angle-right"></i> <a href="https://www.andrewcbancroft.com/2015/10/05/preparing-to-test-receipt-validation-for-ios/" title="Preparing to Test Receipt Validation for iOS">Preparing to Test Receipt Validation for iOS</a>
    </li>
    <li>
      <i class="fa fa-angle-right"></i> <a href="https://www.andrewcbancroft.com/2015/10/13/loading-a-receipt-for-validation-with-swift/" title="Loading a Receipt for Validation with Swift">Loading a Receipt for Validation with Swift</a>
    </li>
    <li>
      <i class="fa fa-angle-right"></i> <a href="https://www.andrewcbancroft.com/2015/09/21/openssl-for-ios-swift-the-easy-way/" title="OpenSSL for iOS &#038; Swift the Easy Way">OpenSSL for iOS & Swift the Easy Way</a>
    </li>
    <li>
      <i class="fa fa-angle-right"></i> <a href="https://www.andrewcbancroft.com/2016/06/09/extracting-a-pkcs7-container-for-receipt-validation-with-swift/" title="Extracting a PKCS7 Container for Receipt Validation with Swift">Extracting a PKCS7 Container for Receipt Validation with Swift</a>
    </li>
    <li>
      <i class="fa fa-angle-right"></i> <a href="https://www.andrewcbancroft.com/2017/07/16/receipt-validation-verifying-a-receipt-signature-in-swift/" title="Receipt Validation – Verifying a Receipt Signature in Swift">Receipt Validation – Verifying a Receipt Signature in Swift</a>
    </li>
    <li>
      <i class="fa fa-angle-right"></i> <a href="https://www.andrewcbancroft.com/2017/07/31/finalizing-receipt-validation-in-swift-computing-a-guid-hash/" title="Finalizing Receipt Validation in Swift – Computing a GUID Hash">Finalizing Receipt Validation in Swift – Computing a GUID Hash</a>
    </li>
  </ul>
</div>
<p><a name="share" class="jump-target"></a></p>


    <div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "andrewcbancroft" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</article>
</div></div></div>



    

    <footer class="footer text-center">
        <div class="container">
            <span class="text-muted">This project contains 185 pages and is available on <a
                    href="https://github.com/andrewcbancroft/andrewcbancroft-blog/tree/master/content/blog">GitHub</a>.
                Copyright &copy; Andrew Bancroft, <time datetime="2023">2023</time>.</span>
        </div>
    </footer>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js"
        integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh"
        crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>

    
    <script>
        function createCopyButton(highlightDiv) {
            const button = document.createElement("button");
            button.className = "copy-code-button";
            button.type = "button";
            button.innerText = "Copy";
            button.addEventListener("click", () =>
                copyCodeToClipboard(button, highlightDiv)
            );
            addCopyButtonToDom(button, highlightDiv);
        }

        async function copyCodeToClipboard(button, highlightDiv) {
            const codeToCopy = highlightDiv.querySelector(":last-child > .chroma > code")
                .innerText;
            try {
                result = await navigator.permissions.query({ name: "clipboard-write" });
                if (result.state == "granted" || result.state == "prompt") {
                    await navigator.clipboard.writeText(codeToCopy);
                } else {
                    copyCodeBlockExecCommand(codeToCopy, highlightDiv);
                }
            } catch (_) {
                copyCodeBlockExecCommand(codeToCopy, highlightDiv);
            } finally {
                codeWasCopied(button);
            }
        }

        function copyCodeBlockExecCommand(codeToCopy, highlightDiv) {
            const textArea = document.createElement("textArea");
            textArea.contentEditable = "true";
            textArea.readOnly = "false";
            textArea.className = "copyable-text-area";
            textArea.value = codeToCopy;
            highlightDiv.insertBefore(textArea, highlightDiv.firstChild);
            const range = document.createRange();
            range.selectNodeContents(textArea);
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
            textArea.setSelectionRange(0, 999999);
            document.execCommand("copy");
            highlightDiv.removeChild(textArea);
        }

        function codeWasCopied(button) {
            button.blur();
            button.innerText = "Copied!";
            setTimeout(function () {
                button.innerText = "Copy";
            }, 2000);
        }

        function addCopyButtonToDom(button, highlightDiv) {
            highlightDiv.insertBefore(button, highlightDiv.firstChild);
            const wrapper = document.createElement("div");
            wrapper.className = "highlight-wrapper";
            highlightDiv.parentNode.insertBefore(wrapper, highlightDiv);
            wrapper.appendChild(highlightDiv);
        }

        document
            .querySelectorAll(".highlight")
            .forEach((highlightDiv) => createCopyButton(highlightDiv));

    </script>
</body>

</html>